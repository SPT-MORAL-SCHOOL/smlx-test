<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPT MORALITY LEADERSHIP - คณะกรรมการนักเรียนขับเคลื่อนโรงเรียนคุณธรรม</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font (using the Thai/Latin glyphs) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+Thai:wght@100..900&display=swap');
        body {
            font-family: 'Noto Sans Thai', 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
    </style>
    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs, runTransaction, FieldValue, increment, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables must be handled carefully.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Use the config provided by the user, wrapped in the required global variable structure.
        const PROVIDED_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCLtVPtIqs6GlHzX108cvFEvLh6Z0i-nBw",
            authDomain: "clip-61b0b.firebaseapp.com",
            projectId: "clip-61b0b",
            storageBucket: "clip-61b0b.firebasestorage.app",
            messagingSenderId: "63156543329",
            appId: "1:63156543329:web:9243a29ec5e3cf4225af20",
            measurementId: "G-JCJVWHD6YK"
        };
        const firebaseConfig = PROVIDED_FIREBASE_CONFIG;
        
        setLogLevel('debug'); // Enable Firestore logging

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global State Variables
        window.db = db;
        window.auth = auth;
        window.appId = appId;
        window.isAdmin = false;
        window.userId = null;
        window.userData = null;
        window.currentPage = 'dashboard';
        window.adminEmail = 'sptmorral@spt.ac.th';

        // Utility: Public and Private Firestore Paths
        window.getPrivatePath = (collectionName, docId) => {
            const path = `/artifacts/${appId}/users/${window.userId}/${collectionName}`;
            return docId ? doc(db, path, docId) : collection(db, path);
        };

        window.getPublicPath = (collectionName, docId) => {
            const path = `/artifacts/${appId}/public/data/${collectionName}`;
            return docId ? doc(db, path, docId) : collection(db, path);
        };

        // Utility: Show Custom Message/Modal
        window.showToast = (message, type = 'success') => {
            const toast = document.getElementById('toast');
            if (!toast) return;

            toast.innerHTML = `<div class="p-3 rounded-xl shadow-lg text-sm font-medium ${type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}">${message}</div>`;
            toast.classList.remove('opacity-0', 'pointer-events-none');
            toast.classList.add('opacity-100', 'pointer-events-auto');

            setTimeout(() => {
                toast.classList.remove('opacity-100', 'pointer-events-auto');
                toast.classList.add('opacity-0', 'pointer-events-none');
            }, 3000);
        };

        // Utility: Date/Time Formatting
        window.formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
            });
        };

        window.formatDateTime = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleTimeString('th-TH', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        };

        // ===================================
        // 1. AUTHENTICATION HANDLERS
        // ===================================

        // 1.1 Initial Auth Sign-in
        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken).catch(err => {
                console.error("Custom token sign-in failed:", err);
                signInAnonymously(auth); // Fallback to anonymous
            });
        } else {
            signInAnonymously(auth); // Sign in anonymously if no token
        }

        // 1.2 Auth State Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.userId = user.uid;
                window.isAdmin = user.email === window.adminEmail;

                // Load user profile
                const profileRef = doc(window.getPrivatePath('profile'), 'data');
                const profileSnap = await getDoc(profileRef);
                
                if (profileSnap.exists()) {
                    window.userData = profileSnap.data();
                    const { isApproved } = window.userData;

                    if (isApproved === false) {
                        renderPage('pendingApproval');
                        return;
                    }
                } else if (!window.isAdmin) {
                    // This user signed in but somehow has no profile (e.g., first sign in via custom token without registration flow)
                    // Or an anonymous user. We will redirect to registration/login if not admin and not approved.
                    // For now, we assume standard flow: user registers, then is approved.
                }

                renderPage(window.currentPage); // Render the main app
            } else {
                window.userId = null;
                window.isAdmin = false;
                window.userData = null;
                renderPage('login'); // Render login screen
            }
        });

        // 1.3 User Login (Existing User)
        window.handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            document.getElementById('loginBtn').disabled = true;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                // Auth state listener handles the rendering after successful login and profile check
            } catch (error) {
                showToast(`เข้าสู่ระบบไม่สำเร็จ: ${error.message}`, 'error');
                document.getElementById('loginBtn').disabled = false;
            }
        };

        // 1.4 User Registration (Awaiting Approval)
        window.handleRegister = async (e) => {
            e.preventDefault();
            const prefix = document.getElementById('regPrefix').value;
            const name = document.getElementById('regName').value;
            const surname = document.getElementById('regSurname').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            document.getElementById('regBtn').disabled = true;

            try {
                // 1. Create Firebase Auth User
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const uid = userCredential.user.uid;

                // 2. Add registration request to public collection
                await setDoc(doc(window.getPublicPath('registration_requests'), uid), {
                    uid: uid,
                    prefix: prefix,
                    name: name,
                    surname: surname,
                    email: email,
                    createdAt: new Date(),
                    status: 'Pending', // Status is Pending
                });

                // 3. Create a placeholder profile (unapproved) in private space for security rules
                await setDoc(doc(window.getPrivatePath('profile', uid), 'data'), {
                    prefix: prefix,
                    name: name,
                    surname: surname,
                    email: email,
                    isApproved: false, // Explicitly set to false
                });

                showToast('ลงทะเบียนสำเร็จ! โปรดรอผู้ดูแลอนุมัติ', 'success');
                // Force logout to show 'pending approval' screen on next sign in, or just redirect to login
                await signOut(auth); 
            } catch (error) {
                showToast(`ลงทะเบียนไม่สำเร็จ: ${error.message}`, 'error');
                document.getElementById('regBtn').disabled = false;
            }
        };

        // 1.5 Logout
        window.handleLogout = async () => {
            try {
                await signOut(auth);
                showToast('ออกจากระบบสำเร็จ', 'success');
            } catch (error) {
                showToast(`ออกจากระบบไม่สำเร็จ: ${error.message}`, 'error');
            }
        };

        // 1.6 Change Password
        window.handleChangePassword = async () => {
            const currentPass = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;

            // Re-authenticate user first (for security purposes, but Firebase handles it on the backend for standard email/pass users if they are currently signed in.)
            // For simplicity in this single file, we will use sendPasswordResetEmail.

            if (auth.currentUser.email) {
                try {
                    await sendPasswordResetEmail(auth, auth.currentUser.email);
                    showToast('ส่งลิงก์รีเซ็ตรหัสผ่านไปยังอีเมลของคุณแล้ว', 'success');
                    document.getElementById('passwordModal').classList.add('hidden');
                } catch (error) {
                    showToast(`ส่งอีเมลรีเซ็ตรหัสผ่านไม่สำเร็จ: ${error.message}`, 'error');
                }
            } else {
                 showToast('ไม่พบอีเมลผู้ใช้งาน', 'error');
            }
        };


        // ===================================
        // 2. DATA LISTENERS & RENDERERS
        // ===================================

        // 2.1 Listeners for Dashboard / Public Data
        window.setupPublicListeners = () => {
            // Activities Listener (Approved only)
            onSnapshot(query(window.getPublicPath('events'), where('isApproved', '==', true)), (snapshot) => {
                const approvedEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDashboard(approvedEvents);
                renderCalendarPage(approvedEvents); // Use the same data for calendar page
            });

            // Links Listener (Approved only)
            onSnapshot(query(window.getPublicPath('links'), where('isApproved', '==', true)), (snapshot) => {
                const approvedLinks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderLatestLinks(approvedLinks);
            });

            // Documents Listener (Approved only)
            onSnapshot(query(window.getPublicPath('documents'), where('isApproved', '==', true)), (snapshot) => {
                const approvedDocs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderLatestDocuments(approvedDocs);
            });

            // Equipment Inventory Listener
            onSnapshot(window.getPublicPath('equipment_inventory'), (snapshot) => {
                const inventory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderEquipmentPage(inventory);
            });

            // Borrow Records Listener
            onSnapshot(query(window.getPublicPath('borrow_records'), where('isReturned', '==', false)), (snapshot) => {
                 const records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 renderEquipmentPage(null, records); // Pass only records, inventory is updated via its own listener
            });
        };
        
        // 2.2 Listener for Admin Approval Requests
        window.setupAdminListeners = () => {
            if (!window.isAdmin) return;
            
            // Get all pending requests for all categories
            const collections = ['registration_requests', 'events', 'links', 'documents'];
            
            collections.forEach(collectionName => {
                let q = window.getPublicPath(collectionName);
                if (collectionName !== 'registration_requests') {
                    q = query(q, where('isApproved', '==', false));
                } else {
                    q = query(q, where('status', '==', 'Pending')); // Registration requests
                }
                
                onSnapshot(q, (snapshot) => {
                    const requests = snapshot.docs.map(doc => ({ id: doc.id, collection: collectionName, ...doc.data() }));
                    renderAdminRequests(collectionName, requests);
                });
            });

             // User Management Listener (all approved users)
             onSnapshot(collection(db, `/artifacts/${appId}/users`), async (snapshot) => {
                const userIds = snapshot.docs.map(doc => doc.id);
                const usersData = [];

                for (const uid of userIds) {
                    const profileRef = doc(db, `/artifacts/${appId}/users/${uid}/profile/data`);
                    const profileSnap = await getDoc(profileRef);
                    if (profileSnap.exists()) {
                        const profile = profileSnap.data();
                        if (profile.isApproved || uid === auth.currentUser.uid) { // Include the current user even if approval status is weirdly missing
                             usersData.push({ id: uid, ...profile });
                        }
                    }
                }
                renderAdminUsers(usersData);
             });
        };

        // ===================================
        // 3. CRUD HANDLERS (Public Submissions)
        // ===================================
        
        // General Submission Handler
        window.handlePublicSubmission = async (e, collectionName) => {
            e.preventDefault();
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;

            const data = {};
            const fields = form.querySelectorAll('input, select, textarea');
            fields.forEach(field => {
                if (field.name) {
                    data[field.name] = field.type === 'checkbox' ? field.checked : field.value;
                }
            });

            data.isApproved = false; // Requires approval
            data.submittedBy = window.userId;
            data.submittedByName = `${window.userData.prefix || ''}${window.userData.name || ''} ${window.userData.surname || ''}`;
            data.createdAt = new Date();

            try {
                await addDoc(window.getPublicPath(collectionName), data);
                showToast(`เพิ่มรายการ ${collectionName} สำเร็จ! โปรดรอผู้ดูแลอนุมัติ`, 'success');
                form.reset();
            } catch (error) {
                console.error("Submission failed:", error);
                showToast(`เพิ่มรายการไม่สำเร็จ: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
            }
        };

        // ===================================
        // 4. EQUIPMENT HANDLERS
        // ===================================

        // 4.1 Borrow Equipment
        window.handleBorrow = async (equipmentId, name) => {
            if (!window.userData.isApproved) {
                showToast('บัญชีของคุณยังไม่ได้รับการอนุมัติให้ใช้งานฟังก์ชันนี้', 'error');
                return;
            }

            const inventoryRef = window.getPublicPath('equipment_inventory', equipmentId);

            try {
                await runTransaction(db, async (transaction) => {
                    const inventoryDoc = await transaction.get(inventoryRef);
                    if (!inventoryDoc.exists()) {
                        throw "Equipment does not exist!";
                    }
                    const data = inventoryDoc.data();
                    
                    if (data.available <= 0) {
                        throw "อุปกรณ์ไม่ว่างสำหรับการยืม";
                    }

                    // 1. Decrement available count
                    transaction.update(inventoryRef, { available: increment(-1) });

                    // 2. Add borrow record
                    const recordRef = window.getPublicPath('borrow_records');
                    transaction.set(doc(recordRef), {
                        equipmentId,
                        equipmentName: name,
                        borrowerId: window.userId,
                        borrowerName: `${window.userData.prefix} ${window.userData.name} ${window.userData.surname}`,
                        borrowDate: new Date(),
                        isReturned: false,
                    });
                });
                showToast(`ยืมอุปกรณ์ ${name} สำเร็จ`, 'success');
            } catch (error) {
                 console.error("Borrow transaction failed:", error);
                 showToast(`ยืมอุปกรณ์ไม่สำเร็จ: ${error}`, 'error');
            }
        };

        // 4.2 Return Equipment
        window.handleReturn = async (recordId, equipmentId, name) => {
            const inventoryRef = window.getPublicPath('equipment_inventory', equipmentId);
            const recordRef = window.getPublicPath('borrow_records', recordId);

            try {
                await runTransaction(db, async (transaction) => {
                    // 1. Mark record as returned
                    transaction.update(recordRef, {
                        isReturned: true,
                        returnDate: new Date(),
                    });

                    // 2. Increment available count in inventory
                    transaction.update(inventoryRef, { available: increment(1) });
                });
                showToast(`คืนอุปกรณ์ ${name} สำเร็จ`, 'success');
            } catch (error) {
                 console.error("Return transaction failed:", error);
                 showToast(`คืนอุปกรณ์ไม่สำเร็จ: ${error.message}`, 'error');
            }
        };


        // ===================================
        // 5. ADMIN HANDLERS
        // ===================================

        // 5.1 Approve/Reject Requests (Activities, Links, Docs, Calendar)
        window.handleRequestApproval = async (collectionName, docId, isApprove) => {
            const docRef = window.getPublicPath(collectionName, docId);
            try {
                if (isApprove) {
                    await updateDoc(docRef, { isApproved: true });
                    showToast(`อนุมัติรายการในหมวดหมู่ ${collectionName} แล้ว`, 'success');
                } else {
                    await deleteDoc(docRef);
                    showToast(`ลบรายการในหมวดหมู่ ${collectionName} แล้ว`, 'success');
                }
            } catch (error) {
                console.error("Approval/Rejection failed:", error);
                showToast('ดำเนินการไม่สำเร็จ', 'error');
            }
        };

        // 5.2 Approve/Reject User Registration
        window.handleUserApproval = async (uid, isApprove) => {
            const regRef = window.getPublicPath('registration_requests', uid);
            const profileRef = doc(db, `/artifacts/${appId}/users/${uid}/profile/data`);
            
            try {
                if (isApprove) {
                    // 1. Update Profile to Approved (allows access)
                    await setDoc(profileRef, { isApproved: true }, { merge: true });
                    // 2. Mark registration request as approved/processed
                    await updateDoc(regRef, { status: 'Approved' });
                    showToast('อนุมัติผู้ใช้งานสำเร็จ', 'success');
                } else {
                    // 1. Delete Auth user (requires Admin SDK, which isn't available, so we just delete records)
                    // We will just delete the profile and registration request, effectively locking them out.
                    await deleteDoc(profileRef);
                    await deleteDoc(regRef);
                    showToast('ปฏิเสธผู้ใช้งานและลบคำขอสำเร็จ', 'success');
                }
            } catch (error) {
                console.error("User Approval/Rejection failed:", error);
                showToast('ดำเนินการไม่สำเร็จ', 'error');
            }
        };

        // 5.3 Admin: Manage Equipment Inventory (Add)
        window.handleAddEquipment = async (e) => {
            e.preventDefault();
            const name = document.getElementById('adminEquipName').value;
            const total = parseInt(document.getElementById('adminEquipTotal').value);
            
            if (!name || isNaN(total) || total <= 0) {
                 showToast('โปรดระบุชื่อและจำนวนอุปกรณ์ที่ถูกต้อง', 'error');
                 return;
            }

            try {
                await addDoc(window.getPublicPath('equipment_inventory'), {
                    name: name,
                    total: total,
                    available: total,
                    createdAt: new Date(),
                });
                showToast(`เพิ่มอุปกรณ์ "${name}" จำนวน ${total} รายการสำเร็จ`, 'success');
                e.target.reset();
            } catch (error) {
                console.error("Add equipment failed:", error);
                showToast('เพิ่มอุปกรณ์ไม่สำเร็จ', 'error');
            }
        };
        
        // 5.4 Admin: Manage Equipment Inventory (Delete)
        window.handleDeleteEquipment = async (equipmentId, name) => {
            if (!confirm(`ยืนยันการลบอุปกรณ์ "${name}"? การดำเนินการนี้จะลบรายการทั้งหมดที่เกี่ยวข้อง`)) return;

             try {
                 await deleteDoc(window.getPublicPath('equipment_inventory', equipmentId));
                 // Note: We don't delete borrow records, they remain as history.
                 showToast(`ลบอุปกรณ์ ${name} สำเร็จ`, 'success');
             } catch (error) {
                 console.error("Delete equipment failed:", error);
                 showToast('ลบอุปกรณ์ไม่สำเร็จ', 'error');
             }
        };

        // 5.5 Admin: Force Return Equipment
        window.handleForceReturn = async (recordId, equipmentId, name) => {
             // Use the standard return function
             if (confirm(`ผู้ดูแล: ยืนยันการบังคับคืนอุปกรณ์ "${name}"?`)) {
                 await handleReturn(recordId, equipmentId, name);
                 showToast(`ผู้ดูแล: บังคับคืนอุปกรณ์ ${name} สำเร็จ`, 'success');
             }
        };

        // 5.6 Admin: Delete User (Note: only deletes profile/request, Auth user remains, but is locked out)
        window.handleAdminDeleteUser = async (uid, email) => {
            if (!confirm(`ยืนยันการลบบัญชีผู้ใช้: ${email}? การดำเนินการนี้ไม่สามารถย้อนกลับได้`)) return;

             try {
                const profileRef = doc(db, `/artifacts/${appId}/users/${uid}/profile/data`);
                const regRef = window.getPublicPath('registration_requests', uid);
                
                // Delete user profile and registration request
                await deleteDoc(profileRef).catch(() => {}); // Catch error if doc doesn't exist
                await deleteDoc(regRef).catch(() => {}); 
                
                showToast(`ลบบัญชีผู้ใช้ ${email} สำเร็จ`, 'success');
             } catch (error) {
                 console.error("Admin delete user failed:", error);
                 showToast('ลบบัญชีไม่สำเร็จ', 'error');
             }
        };

        // ===================================
        // 6. MAIN RENDERING LOGIC
        // ===================================

        window.renderPage = (page) => {
            window.currentPage = page;
            const mainContent = document.getElementById('appContent');
            const authContent = document.getElementById('authContent');
            
            if (!window.userId) {
                // Must be login or register page
                mainContent.classList.add('hidden');
                authContent.classList.remove('hidden');
                authContent.innerHTML = page === 'register' ? getRegisterPage() : getLoginPage();
                return;
            } 
            
            // Logged in user: Check approval status first
            if (page === 'pendingApproval') {
                mainContent.classList.add('hidden');
                authContent.classList.remove('hidden');
                authContent.innerHTML = getPendingApprovalPage();
                return;
            }

            // Approved user (or admin)
            authContent.classList.add('hidden');
            mainContent.classList.remove('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Set up sidebar and header
            document.getElementById('headerContainer').innerHTML = getHeader(page);
            document.getElementById('sidebarContainer').innerHTML = getSidebar(page);

            // Set up listeners once the user is logged in
            setupPublicListeners();
            if (window.isAdmin) {
                setupAdminListeners();
            }

            // Render specific page content
            switch (page) {
                case 'dashboard':
                    mainContent.innerHTML = getDashboardTemplate();
                    break;
                case 'activities':
                    mainContent.innerHTML = getActivitiesPage();
                    break;
                case 'links':
                    mainContent.innerHTML = getLinksPage();
                    break;
                case 'documents':
                    mainContent.innerHTML = getDocumentsPage();
                    break;
                case 'equipment':
                    mainContent.innerHTML = getEquipmentTemplate();
                    break;
                case 'calendar':
                    mainContent.innerHTML = getCalendarPage();
                    break;
                case 'admin':
                    if (window.isAdmin) {
                        mainContent.innerHTML = getAdminPageTemplate();
                    } else {
                        mainContent.innerHTML = `<div class="p-8 text-center text-red-500 font-bold">คุณไม่มีสิทธิ์เข้าถึงหน้านี้</div>`;
                    }
                    break;
                default:
                    mainContent.innerHTML = getDashboardTemplate();
            }
        };


        // ===================================
        // 7. UI TEMPLATE FUNCTIONS (HTML/TAILWIND)
        // ===================================

        // 7.1 Logo
        window.getLogo = (size = 'h-10') => `
             <div class="flex items-center space-x-2">
                <img src="https://img5.pic.in.th/file/secure-sv1/IMG_25650953161d1c1bbdd8.jpeg" alt="" class="${size} w-auto rounded-lg shadow-md">
                <span class="text-lg font-extrabold text-gray-800 hidden md:block">SPT MORALITY</span>
            </div>
        `;

        // 7.2 Menu Items
        window.menuItems = [
            { id: 'dashboard', name: 'หน้าหลัก', icon: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6' },
            { id: 'activities', name: 'กิจกรรม', icon: 'M13 10V3L4 14h7v7l9-11h-7z' },
            { id: 'links', name: 'ลิงก์สำคัญ', icon: 'M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-5.61 5.61l-1.558 3.565 3.566-1.558.793-.793-2.828-2.828-.793.793zm.56 5.61l.707.707L12 15l-1.707-1.707-3.566 1.558z' },
            { id: 'documents', name: 'เอกสาร', icon: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z' },
            { id: 'equipment', name: 'ยืม-คืนอุปกรณ์', icon: 'M4 7v10m0 0h16v-4M4 17h16M4 7h16M14 12a2 2 0 100-4 2 2 0 000 4z' },
            { id: 'calendar', name: 'ปฏิทินรวม', icon: 'M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z' },
        ];
        
        // 7.3 Sidebar (Desktop/Mobile Menu)
        window.getSidebar = (activePage) => {
            const menuHtml = menuItems.map(item => `
                <button onclick="renderPage('${item.id}'); closeMobileMenu()" 
                    class="flex items-center px-4 py-3 rounded-xl transition-all duration-200 w-full text-left
                           ${item.id === activePage ? 'bg-indigo-600 text-white shadow-lg' : 'text-gray-600 hover:bg-indigo-100 hover:text-indigo-700'}"
                >
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${item.icon}"></path></svg>
                    <span class="font-medium">${item.name}</span>
                </button>
            `).join('');

            const adminMenu = window.isAdmin ? `
                 <div class="mt-4 pt-4 border-t border-indigo-100">
                    <button onclick="renderPage('admin'); closeMobileMenu()" 
                        class="flex items-center px-4 py-3 rounded-xl transition-all duration-200 w-full text-left
                               ${activePage === 'admin' ? 'bg-pink-600 text-white shadow-lg' : 'text-pink-600 hover:bg-pink-100'}"
                    >
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span class="font-medium">จัดการระบบ (ผู้ดูแล)</span>
                    </button>
                </div>
            ` : '';

            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 z-30 transition-opacity md:hidden hidden" id="mobileOverlay" onclick="closeMobileMenu()"></div>
                <div id="mobileSidebar" class="fixed top-0 left-0 h-full w-64 bg-white p-6 shadow-2xl z-40 transform -translate-x-full transition-transform duration-300 ease-in-out md:static md:translate-x-0 md:w-64 md:shadow-lg md:rounded-r-2xl">
                    <div class="flex items-center justify-between mb-8">
                        ${getLogo('h-8')}
                        <button class="md:hidden text-gray-700 hover:text-indigo-600" onclick="closeMobileMenu()">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    <nav class="space-y-2">
                        ${menuHtml}
                    </nav>
                    ${adminMenu}
                     <div class="mt-8 pt-6 border-t border-gray-100">
                        <button onclick="document.getElementById('passwordModal').classList.remove('hidden')"
                            class="flex items-center px-4 py-2 w-full text-left text-sm text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors"
                        >
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2v5.5a2.5 2.5 0 01-5 0V9a2 2 0 012-2z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 12h4"></path></svg>
                            แก้ไขรหัสผ่าน
                        </button>
                        <button onclick="handleLogout()"
                            class="flex items-center px-4 py-2 w-full text-left text-sm text-red-500 hover:text-white hover:bg-red-500 rounded-lg transition-colors mt-2"
                        >
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            ออกจากระบบ
                        </button>
                     </div>
                </div>
            `;
        };
        
        // 7.4 Header (Top Bar)
        window.getHeader = (activePage) => {
             const userDisplay = window.userData ? `
                <div class="hidden sm:flex items-center bg-indigo-50 text-indigo-700 py-2 px-4 rounded-full text-sm font-semibold shadow-inner">
                    <span class="mr-2">${window.userData.prefix || ''} ${window.userData.name || ''} ${window.userData.surname || ''}</span>
                    <span class="text-xs text-indigo-500">| ${window.isAdmin ? 'ผู้ดูแล' : 'กรรมการ'}</span>
                </div>
             ` : '';

            const pageTitle = menuItems.find(i => i.id === activePage)?.name || 'แดชบอร์ด';

            return `
                <div class="flex items-center justify-between p-4 bg-white shadow-md rounded-xl">
                    <div class="flex items-center">
                        <button class="md:hidden text-gray-700 hover:text-indigo-600 mr-4" onclick="openMobileMenu()">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                        </button>
                        <h1 class="text-2xl font-bold text-gray-800">${pageTitle}</h1>
                    </div>
                    ${userDisplay}
                </div>
            `;
        };

        // 7.5 Mobile Menu Controls
        window.openMobileMenu = () => {
             document.getElementById('mobileSidebar').classList.remove('-translate-x-full');
             document.getElementById('mobileOverlay').classList.remove('hidden');
        };
        window.closeMobileMenu = () => {
             document.getElementById('mobileSidebar').classList.add('-translate-x-full');
             document.getElementById('mobileOverlay').classList.add('hidden');
        };


        // 7.6 Login Page Template
        window.getLoginPage = () => `
            <div class="min-h-screen flex items-center justify-center p-4 bg-indigo-50">
                <div class="w-full max-w-md bg-white p-8 md:p-10 rounded-3xl shadow-2xl">
                    <div class="flex justify-center mb-6">${getLogo('h-12')}</div>
                    <h2 class="text-2xl font-bold text-gray-800 text-center mb-1">เข้าสู่ระบบ</h2>
                    <p class="text-center text-gray-500 mb-8">คณะกรรมการนักเรียนขับเคลื่อนโรงเรียนคุณธรรม</p>
                    <form onsubmit="handleLogin(event)">
                        <div class="mb-4">
                            <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-1">อีเมล</label>
                            <input type="email" id="loginEmail" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="อีเมลของคุณ" required>
                        </div>
                        <div class="mb-6">
                            <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">รหัสผ่าน</label>
                            <input type="password" id="loginPassword" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="รหัสผ่าน" required>
                        </div>
                        <button type="submit" id="loginBtn" class="w-full bg-indigo-600 text-white p-3 rounded-xl font-semibold hover:bg-indigo-700 transition duration-150 shadow-lg hover:shadow-xl">
                            เข้าสู่ระบบ
                        </button>
                    </form>
                    <p class="mt-6 text-center text-sm text-gray-600">
                        ยังไม่มีบัญชี? 
                        <a href="#" onclick="renderPage('register')" class="text-indigo-600 hover:text-indigo-800 font-medium">ลงทะเบียน</a>
                    </p>
                </div>
            </div>
        `;
        
        // 7.7 Registration Page Template
        window.getRegisterPage = () => `
            <div class="min-h-screen flex items-center justify-center p-4 bg-indigo-50">
                <div class="w-full max-w-md bg-white p-8 md:p-10 rounded-3xl shadow-2xl">
                    <div class="flex justify-center mb-6">${getLogo('h-10')}</div>
                    <h2 class="text-2xl font-bold text-gray-800 text-center mb-1">ลงทะเบียนใช้งาน</h2>
                    <p class="text-center text-gray-500 mb-8 text-sm">ต้องรอผู้ดูแลอนุมัติก่อนจึงจะใช้งานได้</p>
                    <form onsubmit="handleRegister(event)">
                        <div class="mb-4">
                            <label for="regPrefix" class="block text-sm font-medium text-gray-700 mb-1">คำนำหน้าชื่อ</label>
                            <select id="regPrefix" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" required>
                                <option value="เด็กชาย">เด็กชาย</option>
                                <option value="เด็กหญิง">เด็กหญิง</option>
                                <option value="นาย">นาย</option>
                                <option value="นางสาว">นางสาว</option>
                                <option value="นาง">นาง</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="regName" class="block text-sm font-medium text-gray-700 mb-1">ชื่อ</label>
                                <input type="text" id="regName" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="ชื่อ" required>
                            </div>
                            <div>
                                <label for="regSurname" class="block text-sm font-medium text-gray-700 mb-1">นามสกุล</label>
                                <input type="text" id="regSurname" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="นามสกุล" required>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="regEmail" class="block text-sm font-medium text-gray-700 mb-1">อีเมล</label>
                            <input type="email" id="regEmail" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="อีเมลโรงเรียน" required>
                        </div>
                        <div class="mb-6">
                            <label for="regPassword" class="block text-sm font-medium text-gray-700 mb-1">รหัสผ่าน</label>
                            <input type="password" id="regPassword" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="รหัสผ่าน (6 ตัวอักษรขึ้นไป)" required minlength="6">
                        </div>
                        <button type="submit" id="regBtn" class="w-full bg-indigo-600 text-white p-3 rounded-xl font-semibold hover:bg-indigo-700 transition duration-150 shadow-lg hover:shadow-xl">
                            ลงทะเบียน
                        </button>
                    </form>
                    <p class="mt-6 text-center text-sm text-gray-600">
                        มีบัญชีอยู่แล้ว? 
                        <a href="#" onclick="renderPage('login')" class="text-indigo-600 hover:text-indigo-800 font-medium">เข้าสู่ระบบ</a>
                    </p>
                </div>
            </div>
        `;

        // 7.8 Pending Approval Page Template
        window.getPendingApprovalPage = () => `
             <div class="min-h-screen flex items-center justify-center p-4 bg-yellow-50">
                 <div class="w-full max-w-md bg-white p-8 md:p-10 rounded-3xl shadow-2xl border-t-8 border-yellow-500">
                     <svg class="mx-auto h-12 w-12 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                     <h2 class="text-2xl font-bold text-gray-800 text-center mt-4 mb-3">รอกาีอนุมัติ</h2>
                     <p class="text-center text-gray-600 mb-6">บัญชีของคุณลงทะเบียนเรียบร้อยแล้ว แต่ต้องรอการอนุมัติจากผู้ดูแลระบบก่อนจึงจะเข้าใช้งานได้</p>
                     <p class="text-center text-sm text-gray-500 mb-8">โปรดติดต่อผู้ดูแลระบบ (${window.adminEmail}) เพื่อสอบถามสถานะการอนุมัติ</p>
                     <button onclick="handleLogout()" class="w-full bg-yellow-500 text-white p-3 rounded-xl font-semibold hover:bg-yellow-600 transition duration-150 shadow-lg">
                         ออกจากระบบ
                     </button>
                 </div>
             </div>
         `;
        
        // 7.9 Dashboard Templates
        window.getDashboardTemplate = () => `
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-4 md:p-8">
                <!-- Column 1: Calendar & Status -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- 1. กิจกรรมและปฏิทินที่จะมาถึง -->
                    <div id="dashboardUpcomingEvents" class="bg-white p-6 rounded-2xl shadow-xl">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">กิจกรรมและปฏิทินที่จะมาถึง</h3>
                        <div class="space-y-3" id="upcomingEventsList">
                           <p class="text-gray-500">กำลังโหลดกิจกรรม...</p>
                        </div>
                    </div>

                    <!-- 2. ปฏิทิน (แสดงผลจากกิจกรรม/ปฏิทิน) -->
                    <div class="bg-white p-6 rounded-2xl shadow-xl">
                         <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ภาพรวมปฏิทิน</h3>
                         <div id="calendarDisplay" class="h-96 w-full text-center flex items-center justify-center text-gray-500">
                             <!-- Calendar will be rendered here -->
                             (ปฏิทินภาพรวมรายเดือนจะแสดงที่นี่)
                         </div>
                    </div>
                </div>

                <!-- Column 2: Links, Docs, Equipment Status -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- 3. สถานะอุปกรณ์ -->
                    <div id="dashboardEquipmentStatus" class="bg-white p-6 rounded-2xl shadow-xl">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">สถานะอุปกรณ์คงเหลือ</h3>
                         <div class="space-y-3" id="equipmentStatusList">
                            <p class="text-gray-500">กำลังโหลดสถานะอุปกรณ์...</p>
                         </div>
                    </div>

                    <!-- 4. ลิงก์ล่าสุด -->
                    <div id="dashboardLatestLinks" class="bg-white p-6 rounded-2xl shadow-xl">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ลิงก์ล่าสุด</h3>
                        <div class="space-y-3" id="latestLinksList">
                             <p class="text-gray-500">กำลังโหลดลิงก์...</p>
                        </div>
                    </div>

                    <!-- 5. เอกสารล่าสุด -->
                    <div id="dashboardLatestDocuments" class="bg-white p-6 rounded-2xl shadow-xl">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">เอกสารล่าสุด</h3>
                        <div class="space-y-3" id="latestDocumentsList">
                            <p class="text-gray-500">กำลังโหลดเอกสาร...</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Dashboard Render Functions
        window.renderDashboard = (events) => {
            // Sort by date and take the next 5 events
            const now = new Date();
            const upcoming = events
                .filter(e => new Date(e.dateStart) >= now)
                .sort((a, b) => new Date(a.dateStart) - new Date(b.dateStart))
                .slice(0, 5);

            const listHtml = upcoming.length > 0
                ? upcoming.map(e => `
                    <div class="border-l-4 ${e.type === 'ประชุม' ? 'border-pink-500' : 'border-indigo-500'} p-3 bg-gray-50 rounded-lg">
                        <p class="font-semibold text-gray-800">${e.name}</p>
                        <p class="text-xs text-gray-500">
                           ${formatDate(e.dateStart)} ${e.isAllDay ? '(ตลอดวัน)' : `${formatDateTime(e.timeStart)} - ${formatDateTime(e.timeEnd)}`}
                           <span class="ml-2 px-2 py-0.5 text-xs rounded-full ${e.type === 'ประชุม' ? 'bg-pink-100 text-pink-600' : 'bg-indigo-100 text-indigo-600'}">${e.type || 'กิจกรรม'}</span>
                        </p>
                    </div>
                `).join('')
                : '<p class="text-gray-500">ไม่มีกิจกรรมที่กำลังจะมาถึง</p>';

            document.getElementById('upcomingEventsList').innerHTML = listHtml;
            
            // Simplified Calendar visualization (just showing the current month days with events)
            const today = new Date();
            const month = today.getMonth();
            const year = today.getFullYear();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay(); // 0 is Sunday

            const calendarGrid = document.createElement('div');
            calendarGrid.className = 'grid grid-cols-7 gap-1 text-center';

            // Day names
            const dayNames = ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'];
            dayNames.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'font-bold text-sm text-gray-600 py-2';
                dayEl.textContent = day;
                calendarGrid.appendChild(dayEl);
            });

            // Blank spaces for start of month
            for (let i = 0; i < firstDay; i++) {
                calendarGrid.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayEvents = events.filter(e => {
                    const eventDate = e.dateStart.toDate();
                    return eventDate.getDate() === day && eventDate.getMonth() === month && eventDate.getFullYear() === year;
                });

                const dayEl = document.createElement('div');
                dayEl.className = 'p-1 h-12 rounded-lg cursor-pointer transition-all hover:bg-indigo-100 relative';
                dayEl.innerHTML = `<span class="font-semibold ${day === today.getDate() && month === today.getMonth() ? 'bg-indigo-500 text-white p-1 rounded-full text-xs' : 'text-gray-800 text-sm'}">${day}</span>`;
                
                if (dayEvents.length > 0) {
                     dayEl.classList.add('bg-indigo-50');
                     dayEl.innerHTML += `<span class="absolute bottom-1 left-1/2 transform -translate-x-1/2 flex space-x-0.5">
                                         ${dayEvents.slice(0, 2).map(e => `<span class="w-1 h-1 rounded-full ${e.type === 'ประชุม' ? 'bg-pink-500' : 'bg-indigo-500'}"></span>`).join('')}
                                         ${dayEvents.length > 2 ? '<span class="text-xs text-gray-500">+</span>' : ''}
                                         </span>`;
                }
                calendarGrid.appendChild(dayEl);
            }

            const calendarContainer = document.getElementById('calendarDisplay');
            if(calendarContainer) {
                 calendarContainer.innerHTML = '';
                 calendarContainer.appendChild(calendarGrid);
            }
        };
        
        window.renderLatestLinks = (links) => {
            const latest = links.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate()).slice(0, 3);

            const listHtml = latest.length > 0
                ? latest.map(link => `
                    <a href="${link.url}" target="_blank" class="block p-3 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition-colors">
                        <p class="font-semibold text-indigo-700 truncate">${link.name}</p>
                        <p class="text-xs text-gray-500 truncate">${link.details}</p>
                    </a>
                `).join('')
                : '<p class="text-gray-500">ไม่มีลิงก์ที่ได้รับการอนุมัติล่าสุด</p>';

            document.getElementById('latestLinksList').innerHTML = listHtml;
        };

        window.renderLatestDocuments = (docs) => {
            const latest = docs.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate()).slice(0, 3);

            const listHtml = latest.length > 0
                ? latest.map(doc => `
                    <a href="${doc.url}" target="_blank" class="block p-3 bg-teal-50 hover:bg-teal-100 rounded-lg transition-colors">
                        <p class="font-semibold text-teal-700 truncate">${doc.name}</p>
                        <p class="text-xs text-gray-500 truncate">${doc.details}</p>
                    </a>
                `).join('')
                : '<p class="text-gray-500">ไม่มีเอกสารที่ได้รับการอนุมัติล่าสุด</p>';

            document.getElementById('latestDocumentsList').innerHTML = listHtml;
        };

        window.renderEquipmentPage = (inventory, borrowRecords) => {
            // This listener is called separately, so handle null/undefined gracefully
            if (inventory) window.inventoryData = inventory;
            if (borrowRecords) window.borrowData = borrowRecords;
            
            const inventoryData = window.inventoryData || [];
            const borrowData = window.borrowData || [];

            // 1. Equipment Status List (for Dashboard/Quick View)
            const statusHtml = inventoryData.length > 0
                ? inventoryData.map(item => `
                    <div class="flex justify-between items-center text-sm">
                        <span class="font-medium text-gray-700">${item.name}</span>
                        <span class="font-bold text-indigo-600">${item.available} / ${item.total}</span>
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-sm">ไม่มีรายการอุปกรณ์</p>';
            
            const dashboardList = document.getElementById('equipmentStatusList');
            if (dashboardList) dashboardList.innerHTML = statusHtml;


            // 2. Equipment Borrow/Return Page Render
            const availableListEl = document.getElementById('availableEquipmentList');
            const borrowedListEl = document.getElementById('borrowedEquipmentList');

            if (availableListEl && borrowedListEl) {
                 // Available Equipment (for borrowing)
                 const availableHtml = inventoryData.length > 0
                     ? inventoryData.map(item => `
                         <div class="flex justify-between items-center p-3 bg-white rounded-xl shadow-sm border border-gray-100">
                             <div>
                                 <p class="font-semibold text-gray-800">${item.name}</p>
                                 <p class="text-sm text-gray-500">คงเหลือ: ${item.available} / ${item.total}</p>
                             </div>
                             <button onclick="handleBorrow('${item.id}', '${item.name}')" 
                                 ${item.available <= 0 ? 'disabled' : ''}
                                 class="bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-600 disabled:bg-gray-400 transition-colors shadow-md">
                                 ยืมอุปกรณ์
                             </button>
                         </div>
                     `).join('')
                     : '<p class="p-4 text-center text-gray-500">ไม่มีอุปกรณ์ในคลัง</p>';
                 
                 availableListEl.innerHTML = availableHtml;
                 
                 // Borrowed Equipment (by current user, for returning)
                 const myBorrowed = borrowData.filter(record => record.borrowerId === window.userId);

                 const borrowedHtml = myBorrowed.length > 0
                     ? myBorrowed.map(record => `
                         <div class="flex justify-between items-center p-3 bg-white rounded-xl shadow-sm border border-gray-100">
                             <div>
                                 <p class="font-semibold text-gray-800">${record.equipmentName}</p>
                                 <p class="text-sm text-gray-500">ยืมเมื่อ: ${formatDate(record.borrowDate)}</p>
                             </div>
                             <button onclick="handleReturn('${record.id}', '${record.equipmentId}', '${record.equipmentName}')" 
                                 class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-600 transition-colors shadow-md">
                                 คืนอุปกรณ์
                             </button>
                         </div>
                     `).join('')
                     : '<p class="p-4 text-center text-gray-500">คุณไม่ได้ยืมอุปกรณ์ใดๆ</p>';
                     
                 borrowedListEl.innerHTML = borrowedHtml;
            }

            // 3. Admin Equipment Management
            const adminEquipmentListEl = document.getElementById('adminEquipmentList');
            const adminBorrowedListEl = document.getElementById('adminBorrowedList');

            if (adminEquipmentListEl && adminBorrowedListEl) {
                // Admin Inventory List
                 const adminInventoryHtml = inventoryData.length > 0
                      ? inventoryData.map(item => `
                          <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border-l-4 border-indigo-300">
                              <div>
                                  <p class="font-semibold text-gray-800">${item.name}</p>
                                  <p class="text-sm text-gray-500">คงเหลือ: ${item.available} / ทั้งหมด: ${item.total}</p>
                              </div>
                              <button onclick="handleDeleteEquipment('${item.id}', '${item.name}')" class="text-red-500 hover:text-red-700 transition-colors">
                                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                              </button>
                          </div>
                      `).join('')
                      : '<p class="p-4 text-center text-gray-500">ไม่มีรายการอุปกรณ์</p>';
                      
                 adminEquipmentListEl.innerHTML = adminInventoryHtml;

                 // Admin Borrowed Records (all)
                 const allBorrowed = borrowData; // All unreturned records

                 const adminBorrowedHtml = allBorrowed.length > 0
                      ? allBorrowed.map(record => `
                          <div class="p-3 bg-white rounded-lg shadow-sm border-l-4 border-red-300">
                              <div class="flex justify-between items-center">
                                  <p class="font-semibold text-gray-800">${record.equipmentName}</p>
                                  <button onclick="handleForceReturn('${record.id}', '${record.equipmentId}', '${record.equipmentName}')" 
                                      class="text-xs bg-red-100 text-red-600 px-3 py-1 rounded-full hover:bg-red-200 transition-colors">
                                      บังคับคืน
                                  </button>
                              </div>
                              <p class="text-sm text-gray-600 mt-1">ผู้ยืม: ${record.borrowerName}</p>
                              <p class="text-xs text-gray-500">ยืมเมื่อ: ${formatDate(record.borrowDate)}</p>
                          </div>
                      `).join('')
                      : '<p class="p-4 text-center text-gray-500">ไม่มีอุปกรณ์ที่ถูกยืมอยู่ในขณะนี้</p>';

                 adminBorrowedListEl.innerHTML = adminBorrowedHtml;
            }
        };


        // 7.10 Activities Page Template
        window.getActivitiesPage = () => `
            <div class="p-4 md:p-8 space-y-8">
                <!-- Add Activity Form -->
                <div class="bg-white p-6 rounded-2xl shadow-xl">
                    <h3 class="text-xl font-bold text-indigo-700 mb-4 border-b pb-2">เพิ่มกิจกรรมใหม่</h3>
                    <p class="text-sm text-gray-500 mb-4">รายการจะถูกแสดงเมื่อผู้ดูแลอนุมัติแล้วเท่านั้น</p>
                    <form onsubmit="handlePublicSubmission(event, 'events')">
                         <input type="hidden" name="type" value="กิจกรรม">
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="col-span-1 md:col-span-2">
                                <label for="name" class="block text-sm font-medium text-gray-700">ชื่อกิจกรรม</label>
                                <input type="text" id="actName" name="name" class="w-full p-3 border border-gray-300 rounded-xl mt-1" required>
                            </div>
                            <div>
                                <label for="dateStart" class="block text-sm font-medium text-gray-700">วันที่เริ่มต้น</label>
                                <input type="date" id="actDateStart" name="dateStart" class="w-full p-3 border border-gray-300 rounded-xl mt-1" required>
                            </div>
                            <div>
                                <label for="timeStart" class="block text-sm font-medium text-gray-700">เวลาเริ่มต้น</label>
                                <input type="time" id="actTimeStart" name="timeStart" class="w-full p-3 border border-gray-300 rounded-xl mt-1">
                            </div>
                            <div>
                                <label for="dateEnd" class="block text-sm font-medium text-gray-700">วันที่สิ้นสุด</label>
                                <input type="date" id="actDateEnd" name="dateEnd" class="w-full p-3 border border-gray-300 rounded-xl mt-1" required>
                            </div>
                            <div>
                                <label for="timeEnd" class="block text-sm font-medium text-gray-700">เวลาสิ้นสุด</label>
                                <input type="time" id="actTimeEnd" name="timeEnd" class="w-full p-3 border border-gray-300 rounded-xl mt-1">
                            </div>
                            <div class="col-span-1 md:col-span-2 flex items-center">
                                <input type="checkbox" id="actAllDay" name="isAllDay" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="actAllDay" class="ml-2 block text-sm text-gray-900">กรณีตลอดทั้งวัน</label>
                            </div>
                            <div class="col-span-1 md:col-span-2">
                                <label for="details" class="block text-sm font-medium text-gray-700">รายละเอียด</label>
                                <textarea id="actDetails" name="details" rows="3" class="w-full p-3 border border-gray-300 rounded-xl mt-1"></textarea>
                            </div>
                         </div>
                         <button type="submit" class="mt-6 bg-indigo-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-indigo-700 transition-colors shadow-lg">
                             ส่งคำขอเพิ่มกิจกรรม
                         </button>
                    </form>
                </div>
                
                <!-- Approved Activities List (same as Dashboard Upcoming) -->
                <div class="bg-white p-6 rounded-2xl shadow-xl">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">กิจกรรมที่ได้รับการอนุมัติแล้ว</h3>
                    <div class="space-y-3" id="upcomingEventsList">
                       <p class="text-gray-500">กำลังโหลดกิจกรรม...</p>
                    </div>
                </div>
            </div>
        `;

        // 7.11 Links Page Template
        window.getLinksPage = () => `
            <div class="p-4 md:p-8 space-y-8">
                 <!-- Add Link Form -->
                 <div class="bg-white p-6 rounded-2xl shadow-xl">
                     <h3 class="text-xl font-bold text-indigo-700 mb-4 border-b pb-2">เพิ่มลิงก์สำคัญ</h3>
                     <p class="text-sm text-gray-500 mb-4">รายการจะถูกแสดงเมื่อผู้ดูแลอนุมัติแล้วเท่านั้น</p>
                     <form onsubmit="handlePublicSubmission(event, 'links')">
                         <div>
                             <label for="linkName" class="block text-sm font-medium text-gray-700">ชื่อลิงก์</label>
                             <input type="text" id="linkName" name="name" class="w-full p-3 border border-gray-300 rounded-xl mt-1" required>
                         </div>
                         <div class="mt-4">
                             <label for="linkUrl" class="block text-sm font-medium text-gray-700">ลิงก์ (URL)</label>
                             <input type="url" id="linkUrl" name="url" class="w-full p-3 border border-gray-300 rounded-xl mt-1" placeholder="เช่น https://..." required>
                         </div>
                         <div class="mt-4">
                             <label for="linkDetails" class="block text-sm font-medium text-gray-700">รายละเอียด</label>
                             <textarea id="linkDetails" name="details" rows="3" class="w-full p-3 border border-gray-300 rounded-xl mt-1"></textarea>
                         </div>
                         <button type="submit" class="mt-6 bg-indigo-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-indigo-700 transition-colors shadow-lg">
                             ส่งคำขอเพิ่มลิงก์
                         </button>
                     </form>
                 </div>

                 <!-- Approved Links List (same as Dashboard Links) -->
                 <div class="bg-white p-6 rounded-2xl shadow-xl">
                     <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ลิงก์ที่ได้รับการอนุมัติแล้ว</h3>
                     <div class="space-y-3" id="latestLinksList">
                          <p class="text-gray-500">กำลังโหลดลิงก์...</p>
                     </div>
                 </div>
            </div>
        `;

        // 7.12 Documents Page Template
        window.getDocumentsPage = () => `
             <div class="p-4 md:p-8 space-y-8">
                  <!-- Add Document Form -->
                  <div class="bg-white p-6 rounded-2xl shadow-xl">
                      <h3 class="text-xl font-bold text-indigo-700 mb-4 border-b pb-2">เพิ่มเอกสาร</h3>
                      <p class="text-sm text-gray-500 mb-4">รายการจะถูกแสดงเมื่อผู้ดูแลอนุมัติแล้วเท่านั้น (โปรดใช้ลิงก์จาก Google Drive หรือแหล่งเก็บไฟล์อื่น)</p>
                      <form onsubmit="handlePublicSubmission(event, 'documents')">
                          <div>
                              <label for="docName" class="block text-sm font-medium text-gray-700">ชื่อเอกสาร</label>
                              <input type="text" id="docName" name="name" class="w-full p-3 border border-gray-300 rounded-xl mt-1" required>
                          </div>
                          <div class="mt-4">
                              <label for="docUrl" class="block text-sm font-medium text-gray-700">ลิงก์เอกสาร (URL)</label>
                              <input type="url" id="docUrl" name="url" class="w-full p-3 border border-gray-300 rounded-xl mt-1" placeholder="เช่น https://drive.google.com/..." required>
                          </div>
                          <div class="mt-4">
                              <label for="docDetails" class="block text-sm font-medium text-gray-700">รายละเอียด</label>
                              <textarea id="docDetails" name="details" rows="3" class="w-full p-3 border border-gray-300 rounded-xl mt-1"></textarea>
                          </div>
                          <button type="submit" class="mt-6 bg-indigo-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-indigo-700 transition-colors shadow-lg">
                              ส่งคำขอเพิ่มเอกสาร
                          </button>
                      </form>
                  </div>

                  <!-- Approved Documents List (same as Dashboard Docs) -->
                  <div class="bg-white p-6 rounded-2xl shadow-xl">
                      <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">เอกสารที่ได้รับการอนุมัติแล้ว</h3>
                      <div class="space-y-3" id="latestDocumentsList">
                           <p class="text-gray-500">กำลังโหลดเอกสาร...</p>
                      </div>
                  </div>
             </div>
        `;

        // 7.13 Equipment Page Template
        window.getEquipmentTemplate = () => `
            <div class="p-4 md:p-8 space-y-8">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Column 1: อุปกรณ์คงเหลือ (มีปุ่มยืมอุปกรณ์) -->
                    <div class="bg-white p-6 rounded-2xl shadow-xl">
                        <h3 class="text-xl font-bold text-indigo-700 mb-4 border-b pb-2">อุปกรณ์คงเหลือ</h3>
                        <div class="space-y-3" id="availableEquipmentList">
                            <p class="text-gray-500 text-center p-4">กำลังโหลดรายการอุปกรณ์...</p>
                        </div>
                    </div>

                    <!-- Column 2: อุปกรณ์ที่ยืม (มีปุ่มคืนอุปกรณ์) -->
                    <div class="bg-white p-6 rounded-2xl shadow-xl">
                        <h3 class="text-xl font-bold text-red-700 mb-4 border-b pb-2">อุปกรณ์ที่คุณกำลังยืม</h3>
                        <div class="space-y-3" id="borrowedEquipmentList">
                            <p class="text-gray-500 text-center p-4">กำลังโหลดรายการที่ยืม...</p>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // 7.14 Calendar Page Template
        window.getCalendarPage = () => `
            <div class="p-4 md:p-8 space-y-8">
                <!-- Add Event Form -->
                <div class="bg-white p-6 rounded-2xl shadow-xl">
                    <h3 class="text-xl font-bold text-indigo-700 mb-4 border-b pb-2">เพิ่มกิจกรรม/การประชุมในปฏิทิน</h3>
                    <p class="text-sm text-gray-500 mb-4">รายการจะถูกแสดงเมื่อผู้ดูแลอนุมัติแล้วเท่านั้น</p>
                    <form onsubmit="handlePublicSubmission(event, 'events')">
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="col-span-1 md:col-span-2">
                                <label for="calName" class="block text-sm font-medium text-gray-700">ชื่อกิจกรรม/ประชุม</label>
                                <input type="text" id="calName" name="name" class="w-full p-3 border border-gray-300 rounded-xl mt-1" required>
                            </div>
                            <div class="col-span-1 md:col-span-2">
                                <label for="calType" class="block text-sm font-medium text-gray-700">ประเภท</label>
                                <select id="calType" name="type" class="w-full p-3 border border-gray-300 rounded-xl mt-1" required>
                                    <option value="กิจกรรม">กิจกรรม</option>
                                    <option value="ประชุม">ประชุม</option>
                                </select>
                            </div>
                            <div>
                                <label for="calDateStart" class="block text-sm font-medium text-gray-700">วันที่เริ่มต้น</label>
                                <input type="date" id="calDateStart" name="dateStart" class="w-full p-3 border border-gray-300 rounded-xl mt-1" required>
                            </div>
                            <div>
                                <label for="calTimeStart" class="block text-sm font-medium text-gray-700">เวลาเริ่มต้น</label>
                                <input type="time" id="calTimeStart" name="timeStart" class="w-full p-3 border border-gray-300 rounded-xl mt-1">
                            </div>
                            <div>
                                <label for="calDateEnd" class="block text-sm font-medium text-gray-700">วันที่สิ้นสุด</label>
                                <input type="date" id="calDateEnd" name="dateEnd" class="w-full p-3 border border-gray-300 rounded-xl mt-1" required>
                            </div>
                            <div>
                                <label for="calTimeEnd" class="block text-sm font-medium text-gray-700">เวลาสิ้นสุด</label>
                                <input type="time" id="calTimeEnd" name="timeEnd" class="w-full p-3 border border-gray-300 rounded-xl mt-1">
                            </div>
                            <div class="col-span-1 md:col-span-2 flex items-center">
                                <input type="checkbox" id="calAllDay" name="isAllDay" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="calAllDay" class="ml-2 block text-sm text-gray-900">กรณีตลอดทั้งวัน</label>
                            </div>
                            <div class="col-span-1 md:col-span-2">
                                <label for="calDetails" class="block text-sm font-medium text-gray-700">รายละเอียด</label>
                                <textarea id="calDetails" name="details" rows="3" class="w-full p-3 border border-gray-300 rounded-xl mt-1"></textarea>
                            </div>
                         </div>
                         <button type="submit" class="mt-6 bg-indigo-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-indigo-700 transition-colors shadow-lg">
                             ส่งคำขอเพิ่มปฏิทิน
                         </button>
                    </form>
                </div>
                
                <!-- Approved Calendar Display (Full Calendar View - Simplified) -->
                <div class="bg-white p-6 rounded-2xl shadow-xl">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ปฏิทินกิจกรรมรวม</h3>
                    <div id="calendarDisplay" class="h-auto w-full text-center flex items-center justify-center text-gray-500">
                        <!-- Calendar will be rendered here via renderDashboard function -->
                    </div>
                </div>
            </div>
        `;
        
        // 7.15 Admin Page Template
        window.getAdminPageTemplate = () => `
            <div class="p-4 md:p-8 space-y-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">หน้าจัดการระบบ (ผู้ดูแล)</h2>

                <!-- 1. คำขออนุมัติ -->
                <div class="bg-white p-6 rounded-2xl shadow-xl">
                    <h3 class="text-xl font-bold text-pink-700 mb-4 border-b pb-2">คำขออนุมัติ (Pending Requests)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div id="requests_registration_requests" class="bg-red-50 p-4 rounded-xl space-y-3">
                            <h4 class="font-bold text-red-700">คำขอลงทะเบียน (0)</h4>
                        </div>
                        <div id="requests_events" class="bg-yellow-50 p-4 rounded-xl space-y-3">
                            <h4 class="font-bold text-yellow-700">คำขอ กิจกรรม/ปฏิทิน (0)</h4>
                        </div>
                        <div id="requests_links" class="bg-green-50 p-4 rounded-xl space-y-3">
                            <h4 class="font-bold text-green-700">คำขอ ลิงก์ (0)</h4>
                        </div>
                        <div id="requests_documents" class="bg-blue-50 p-4 rounded-xl space-y-3">
                            <h4 class="font-bold text-blue-700">คำขอ เอกสาร (0)</h4>
                        </div>
                    </div>
                </div>

                <!-- 2. จัดการอุปกรณ์ -->
                <div class="bg-white p-6 rounded-2xl shadow-xl">
                    <h3 class="text-xl font-bold text-indigo-700 mb-4 border-b pb-2">จัดการอุปกรณ์</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Add Equipment -->
                        <div class="lg:col-span-1 p-4 bg-gray-50 rounded-xl border border-gray-200">
                            <h4 class="font-semibold text-gray-700 mb-3">เพิ่มอุปกรณ์ใหม่</h4>
                            <form onsubmit="handleAddEquipment(event)">
                                <div class="mb-3">
                                    <input type="text" id="adminEquipName" placeholder="ชื่ออุปกรณ์ (เช่น ปากกาไวท์บอร์ด)" class="w-full p-2 border border-gray-300 rounded-lg" required>
                                </div>
                                <div class="mb-3">
                                    <input type="number" id="adminEquipTotal" placeholder="จำนวนเริ่มต้น" class="w-full p-2 border border-gray-300 rounded-lg" min="1" required>
                                </div>
                                <button type="submit" class="w-full bg-indigo-500 text-white p-2 rounded-lg font-medium hover:bg-indigo-600 transition-colors">เพิ่มอุปกรณ์</button>
                            </form>
                        </div>
                        
                        <!-- Inventory List -->
                        <div class="lg:col-span-1">
                             <h4 class="font-semibold text-gray-700 mb-3 border-b pb-2">รายการอุปกรณ์ในคลัง (ลบ/คงเหลือ)</h4>
                             <div class="space-y-2 max-h-96 overflow-y-auto" id="adminEquipmentList">
                                <p class="text-gray-500 text-center">กำลังโหลด...</p>
                             </div>
                        </div>

                        <!-- Borrowed List -->
                        <div class="lg:col-span-1">
                             <h4 class="font-semibold text-gray-700 mb-3 border-b pb-2">อุปกรณ์ที่ถูกยืม (บังคับคืน)</h4>
                             <div class="space-y-2 max-h-96 overflow-y-auto" id="adminBorrowedList">
                                 <p class="text-gray-500 text-center">กำลังโหลด...</p>
                             </div>
                        </div>
                    </div>
                </div>
                
                <!-- 3. จัดการผู้ใช้งาน -->
                <div class="bg-white p-6 rounded-2xl shadow-xl">
                    <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2">จัดการผู้ใช้งาน</h3>
                    <div id="adminUserList" class="space-y-3">
                        <p class="text-gray-500 text-center">กำลังโหลดรายการผู้ใช้งาน...</p>
                    </div>
                </div>
            </div>
        `;

        // Admin Render Functions
        window.renderAdminRequests = (collectionName, requests) => {
            const containerId = `requests_${collectionName}`;
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const titleElement = container.querySelector('h4');
            const typeMap = {
                'registration_requests': { title: 'คำขอลงทะเบียน', bg: 'bg-red-50', text: 'text-red-700', approveText: 'อนุมัติ', rejectText: 'ปฏิเสธ', handler: 'handleUserApproval' },
                'events': { title: 'คำขอ กิจกรรม/ปฏิทิน', bg: 'bg-yellow-50', text: 'text-yellow-700', approveText: 'อนุมัติ', rejectText: 'ลบทิ้ง', handler: 'handleRequestApproval' },
                'links': { title: 'คำขอ ลิงก์', bg: 'bg-green-50', text: 'text-green-700', approveText: 'อนุมัติ', rejectText: 'ลบทิ้ง', handler: 'handleRequestApproval' },
                'documents': { title: 'คำขอ เอกสาร', bg: 'bg-blue-50', text: 'text-blue-700', approveText: 'อนุมัติ', rejectText: 'ลบทิ้ง', handler: 'handleRequestApproval' },
            };
            const config = typeMap[collectionName];

            titleElement.textContent = `${config.title} (${requests.length})`;
            container.className = `${config.bg} p-4 rounded-xl space-y-3`;

            const listHtml = requests.filter(r => r.status !== 'Approved').map(req => {
                let primaryInfo = '';
                let secondaryInfo = '';
                let docId = req.id;
                
                if (collectionName === 'registration_requests') {
                    primaryInfo = `${req.prefix} ${req.name} ${req.surname}`;
                    secondaryInfo = req.email;
                    docId = req.uid; // Use UID for user approval handler
                } else {
                    primaryInfo = req.name;
                    secondaryInfo = req.details || req.url || '';
                }

                return `
                    <div class="p-3 bg-white rounded-lg shadow-sm">
                        <p class="font-semibold text-gray-800 text-sm">${primaryInfo}</p>
                        <p class="text-xs text-gray-500 truncate">${secondaryInfo}</p>
                        <div class="flex space-x-2 mt-2">
                             <button onclick="${config.handler}('${collectionName}', '${docId}', true)" class="text-xs bg-green-500 text-white px-3 py-1 rounded-full hover:bg-green-600">${config.approveText}</button>
                             <button onclick="${config.handler}('${collectionName}', '${docId}', false)" class="text-xs bg-red-500 text-white px-3 py-1 rounded-full hover:bg-red-600">${config.rejectText}</button>
                        </div>
                    </div>
                `;
            }).join('');

            if (requests.length === 0) {
                 container.innerHTML += `<p class="text-gray-500 text-center text-sm">ไม่มีคำขอที่ต้องอนุมัติ</p>`;
            } else {
                 // Clear previous content and append the list after the title
                 container.innerHTML = titleElement.outerHTML + listHtml;
            }
        };

        window.renderAdminUsers = (users) => {
            const container = document.getElementById('adminUserList');
            if (!container) return;

            const listHtml = users.map(user => `
                <div class="flex justify-between items-center p-4 bg-gray-50 rounded-xl shadow-sm border border-gray-200">
                    <div>
                        <p class="font-semibold text-gray-800">${user.prefix || ''} ${user.name || ''} ${user.surname || ''}</p>
                        <p class="text-sm text-gray-500">${user.email}</p>
                    </div>
                    <div class="flex space-x-2">
                         <button onclick="sendPasswordResetEmail(auth, '${user.email}'); showToast('ส่งลิงก์รีเซ็ตรหัสผ่านไปยังอีเมลผู้ใช้แล้ว', 'success')" 
                             class="text-xs bg-blue-100 text-blue-600 px-3 py-1 rounded-full hover:bg-blue-200 transition-colors"
                             ${user.id === auth.currentUser.uid ? 'disabled' : ''}>
                             รีเซ็ตรหัสผ่าน
                         </button>
                         <button onclick="handleAdminDeleteUser('${user.id}', '${user.email}')" 
                             class="text-xs bg-red-100 text-red-600 px-3 py-1 rounded-full hover:bg-red-200 transition-colors"
                             ${user.id === auth.currentUser.uid ? 'disabled' : ''}>
                             ลบบัญชี
                         </button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = listHtml || '<p class="text-gray-500 text-center p-4">ไม่มีผู้ใช้งานที่ได้รับการอนุมัติ</p>';
        };
    </script>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Toast Notification Area -->
    <div id="toast" class="fixed top-5 right-5 z-50 transition-opacity duration-300 opacity-0 pointer-events-none"></div>

    <!-- Modals -->
    <!-- Change Password Modal -->
    <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden" onclick="if(event.target.id === 'passwordModal') this.classList.add('hidden')">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4 border-b pb-2">แก้ไขรหัสผ่าน</h3>
            <p class="text-sm text-gray-600 mb-4">ระบบจะส่งลิงก์รีเซ็ตรหัสผ่านไปยังอีเมลของคุณ</p>
            <form onsubmit="event.preventDefault(); handleChangePassword()">
                <!-- We skip current/new password inputs for security since we use sendPasswordResetEmail -->
                <button type="submit" class="w-full bg-indigo-600 text-white p-3 rounded-xl font-semibold hover:bg-indigo-700 transition-colors shadow-lg">
                    ส่งลิงก์รีเซ็ตรหัสผ่าน
                </button>
                <button type="button" onclick="document.getElementById('passwordModal').classList.add('hidden')" class="w-full mt-2 text-gray-600 p-3 rounded-xl font-medium hover:bg-gray-100 transition-colors">
                    ยกเลิก
                </button>
            </form>
        </div>
    </div>


    <!-- Authentication Content (Visible when logged out or pending approval) -->
    <div id="authContent" class="min-h-screen">
        <!-- Renders Login/Register/Pending Approval pages -->
        <div class="text-center p-8">กำลังโหลดระบบ...</div>
    </div>

    <!-- Main Application Container (Visible when logged in and approved) -->
    <div id="mainApp" class="hidden min-h-screen flex flex-col md:flex-row">
        <!-- Sidebar (Desktop & Mobile) -->
        <div id="sidebarContainer" class="md:sticky md:top-0 md:h-screen md:flex-shrink-0">
            <!-- Content rendered by getSidebar() -->
        </div>

        <!-- Main Content Area -->
        <div class="flex-grow flex flex-col">
            <!-- Header (Top Bar) -->
            <div id="headerContainer" class="sticky top-0 z-20 bg-gray-50 p-4 md:p-6">
                <!-- Content rendered by getHeader() -->
            </div>

            <!-- Page Content -->
            <main id="appContent" class="flex-grow">
                <!-- Content rendered by renderPage() -->
            </main>

            <!-- Footer -->
            <footer class="mt-auto p-4 md:p-6 text-center text-sm text-gray-500 border-t border-gray-100 bg-white shadow-inner rounded-t-xl">
                 &copy; 2024 SPT MORAL SCHOOL - โรงเรียนคุณธรรม สพฐ. โรงเรียนสตรีพัทลุง | All Rights Reserved
            </footer>
        </div>
    </div>

</body>
</html>

