<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>STUDENT MORALITY LEADERSHIP COMMITTEE | SPT MORAL SCHOOL</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#ffffff;
      --card:#f6f8fb;
      --muted:#6b7280;
      --text:#0f172a;
      --primary:#2563eb;
      --primary-600:#1d4ed8;
      --ring: 0 10px 30px rgba(37, 99, 235, .15);
      --shadow: 0 10px 30px rgba(15, 23, 42, .06);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: 'Prompt', system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text); background:linear-gradient(180deg,#fbfdff, #f3f6fb);
    }
    img{max-width:100%; display:block}

    /* Layout */
    .app{
      min-height:100vh; display:grid; grid-template-rows:auto 1fr auto;
    }
    header{
      position:sticky; top:0; z-index:20; background:rgba(255,255,255,.7); backdrop-filter: blur(10px);
      border-bottom:1px solid #e5e7eb;
    }
    .container{max-width:1200px; margin:0 auto; padding:16px;}
    .brand{display:flex; align-items:center; gap:12px}
    .brand img{width:40px; height:40px; border-radius:50%; object-fit:cover; box-shadow:var(--shadow)}
    .brand h1{font-size:18px; line-height:1.2; margin:0}
    .brand small{display:block; color:var(--muted); font-weight:400}

    .nav{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    }
    .nav button, .btn{
      appearance:none; border:none; background:var(--card); color:var(--text);
      padding:10px 14px; border-radius:12px; cursor:pointer; transition:.2s ease; font-weight:500;
    }
    .nav button.active{background:var(--primary); color:white; box-shadow:var(--ring)}
    .btn.primary{background:var(--primary); color:#fff; box-shadow:var(--ring)}
    .btn.primary:hover{background:var(--primary-600)}
    .btn.ghost{background:transparent}
    .btn.danger{background:#ef4444; color:#fff}

    main{padding:24px 16px}
    .grid{
      display:grid; gap:16px; grid-template-columns: repeat(12, 1fr);
    }
    .card{
      background:var(--bg); border:1px solid #e5e7eb; border-radius:var(--radius); box-shadow:var(--shadow);
      padding:16px;
    }
    .card h3{margin:0 0 12px}

    /* Auth screens */
    .auth-wrap{min-height:calc(100vh - 160px); display:grid; place-items:center}
    .auth-card{width:100%; max-width:900px; display:grid; grid-template-columns: 1.2fr 1fr; gap:24px}
    .auth-side{background:var(--bg); border:1px solid #e5e7eb; border-radius:var(--radius); box-shadow:var(--shadow); padding:24px}
    .form{display:grid; gap:12px}
    .row{display:grid; gap:12px; grid-template-columns: 1fr 1fr}
    label{font-weight:500}
    input, select, textarea{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid #e5e7eb; background:#fff; outline:none; transition:.15s;
    }
    input:focus, select:focus, textarea:focus{border-color:var(--primary); box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    .helper{color:var(--muted); font-size:12px}

    /* Sections */
    .hidden{display:none !important}
    .toolbar{display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:12px}
    .list{display:grid; gap:12px}
    .item{padding:12px; border:1px solid #e5e7eb; border-radius:12px; background:#fff; display:grid; gap:6px}
    .item .meta{color:var(--muted); font-size:12px}

    /* Calendar placeholder */
    .calendar{display:grid; gap:8px; grid-template-columns: repeat(7, 1fr)}
    .day{border:1px dashed #e5e7eb; min-height:80px; border-radius:10px; padding:8px; background:#fff}

    /* Responsive */
    @media (max-width: 960px){
      .auth-card{grid-template-columns: 1fr}
      .row{grid-template-columns: 1fr}
      .nav{justify-content:flex-start; overflow-x:auto}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="container" style="display:flex; align-items:center; justify-content:space-between; gap:16px;">
        <div class="brand">
          <img src="https://img5.pic.in.th/file/secure-sv1/IMG_25650953161d1c1bbdd8.jpeg" alt="SPT Moral School Logo"/>
          <div>
            <h1>STUDENT MORALITY LEADERSHIP COMMITTEE</h1>
            <small>โรงเรียนคุณธรรม สพฐ. | โรงเรียนสตรีพัทลุง</small>
          </div>
        </div>
        <nav class="nav" id="nav">
          <!-- Dynamic menu injected here -->
        </nav>
      </div>
    </header>

    <main class="container">
      <!-- Auth Screens -->
      <section id="auth" class="auth-wrap">
        <div class="auth-card">
          <div class="auth-side">
            <h2 style="margin-top:0">เข้าสู่ระบบ</h2>
            <form id="loginForm" class="form">
              <input type="email" id="loginEmail" placeholder="อีเมล" required />
              <input type="password" id="loginPassword" placeholder="รหัสผ่าน" required />
              <button type="submit" class="btn primary">เข้าสู่ระบบ</button>
              <div class="helper">ยังไม่มีบัญชี? <a href="#" id="goRegister">สมัครสมาชิก</a></div>
            </form>
          </div>
          <div class="auth-side">
            <h2 style="margin-top:0">สมัครสมาชิก</h2>
            <form id="registerForm" class="form">
              <div class="row">
                <div>
                  <label for="title">คำนำหน้าชื่อ</label>
                  <select id="title" required>
                    <option value="">เลือก</option>
                    <option>เด็กชาย</option>
                    <option>เด็กหญิง</option>
                    <option>นาย</option>
                    <option>นางสาว</option>
                    <option>นาง</option>
                  </select>
                </div>
                <div>
                  <label for="firstName">ชื่อ</label>
                  <input id="firstName" required />
                </div>
              </div>
              <div class="row">
                <div>
                  <label for="lastName">นามสกุล</label>
                  <input id="lastName" required />
                </div>
                <div>
                  <label for="regEmail">อีเมล</label>
                  <input id="regEmail" type="email" required />
                </div>
              </div>
              <div class="row">
                <div>
                  <label for="regPassword">รหัสผ่าน</label>
                  <input id="regPassword" type="password" minlength="6" required />
                </div>
                <div>
                  <label for="regPassword2">ยืนยันรหัสผ่าน</label>
                  <input id="regPassword2" type="password" minlength="6" required />
                </div>
              </div>
              <button type="submit" class="btn primary">ลงทะเบียน</button>
              <div class="helper">ลงทะเบียนแล้ว? <a href="#" id="goLogin">เข้าสู่ระบบ</a></div>
            </form>
          </div>
        </div>
      </section>

      <!-- App Sections -->
      <section id="app" class="hidden">
        <div class="toolbar">
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <button class="btn" data-route="dashboard">หน้าหลัก</button>
            <button class="btn" data-route="events">กิจกรรม</button>
            <button class="btn" data-route="links">ลิงก์</button>
            <button class="btn" data-route="docs">เอกสาร</button>
            <button class="btn" data-route="inventory">ยืม-คืนอุปกรณ์</button>
            <button class="btn" data-route="calendar">ปฏิทิน</button>
            <button class="btn admin-only hidden" data-route="admin">จัดการระบบ</button>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <button id="changePasswordBtn" class="btn">แก้ไขรหัสผ่าน</button>
            <button id="logoutBtn" class="btn">ออกจากระบบ</button>
          </div>
        </div>

        <div id="route-dashboard" class="route">
          <div class="grid">
            <div class="card" style="grid-column: span 8;">
              <h3>ปฏิทิน</h3>
              <div id="dashboardCalendar" class="calendar"></div>
            </div>
            <div class="card" style="grid-column: span 4;">
              <h3>สถานะอุปกรณ์</h3>
              <div id="dashboardInventory" class="list"></div>
            </div>
            <div class="card" style="grid-column: span 4;">
              <h3>ลิงก์ล่าสุด</h3>
              <div id="dashboardLinks" class="list"></div>
            </div>
            <div class="card" style="grid-column: span 4;">
              <h3>เอกสารล่าสุด</h3>
              <div id="dashboardDocs" class="list"></div>
            </div>
            <div class="card" style="grid-column: span 4;">
              <h3>กิจกรรมและปฏิทินที่จะมาถึง</h3>
              <div id="dashboardUpcoming" class="list"></div>
            </div>
          </div>
        </div>

        <div id="route-events" class="route hidden">
          <div class="card">
            <div class="toolbar">
              <h3 style="margin:0">กิจกรรม</h3>
              <button id="addEventBtn" class="btn primary">เพิ่มกิจกรรม</button>
            </div>
            <div id="eventsList" class="list"></div>
          </div>
        </div>

        <div id="route-links" class="route hidden">
          <div class="card">
            <div class="toolbar">
              <h3 style="margin:0">ลิงก์</h3>
              <button id="addLinkBtn" class="btn primary">เพิ่มลิงก์</button>
            </div>
            <div id="linksList" class="list"></div>
          </div>
        </div>

        <div id="route-docs" class="route hidden">
          <div class="card">
            <div class="toolbar">
              <h3 style="margin:0">เอกสาร</h3>
              <button id="addDocBtn" class="btn primary">เพิ่มเอกสาร</button>
            </div>
            <div id="docsList" class="list"></div>
          </div>
        </div>

        <div id="route-inventory" class="route hidden">
          <div class="grid">
            <div class="card" style="grid-column: span 6;">
              <div class="toolbar">
                <h3 style="margin:0">อุปกรณ์คงเหลือ</h3>
              </div>
              <div id="inventoryAvailable" class="list"></div>
            </div>
            <div class="card" style="grid-column: span 6;">
              <div class="toolbar">
                <h3 style="margin:0">อุปกรณ์ที่ยืม</h3>
              </div>
              <div id="inventoryBorrowed" class="list"></div>
            </div>
          </div>
        </div>

        <div id="route-calendar" class="route hidden">
          <div class="card">
            <div class="toolbar">
              <h3 style="margin:0">ปฏิทิน</h3>
              <button id="addCalendarBtn" class="btn primary">เพิ่มกิจกรรม</button>
            </div>
            <div id="calendarView" class="calendar"></div>
          </div>
        </div>

        <div id="route-admin" class="route hidden">
          <div class="grid">
            <div class="card" style="grid-column: span 6;">
              <h3>คำขอการอนุมัติ</h3>
              <div id="approvals" class="list"></div>
            </div>
            <div class="card" style="grid-column: span 6;">
              <div class="toolbar">
                <h3 style="margin:0">จัดการอุปกรณ์</h3>
                <button id="addEquipmentBtn" class="btn primary">เพิ่มอุปกรณ์</button>
              </div>
              <div id="equipmentList" class="list"></div>
            </div>
            <div class="card" style="grid-column: span 12;">
              <h3>จัดการผู้ใช้งาน</h3>
              <div id="usersList" class="list"></div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer style="border-top:1px solid #e5e7eb; background:#fff;">
      <div class="container" style="text-align:center; padding:20px; color:var(--muted)">
        &copy; 2024 SPT MORAL SCHOOL - โรงเรียนคุณธรรม สพฐ. โรงเรียนสตรีพัทลุง | All Rights Reserved
      </div>
    </footer>
  </div>

  <!-- Dialogs -->
  <dialog id="modal" style="border:none; border-radius:16px; padding:0; width:min(680px, 92vw); box-shadow:var(--shadow)">
    <form method="dialog" style="padding:16px 16px 0; display:flex; align-items:center; justify-content:space-between; gap:8px">
      <strong id="modalTitle">Modal</strong>
      <button class="btn ghost" value="cancel">ปิด</button>
    </form>
    <div id="modalBody" style="padding:16px"></div>
    <div style="padding:0 16px 16px; display:flex; justify-content:flex-end; gap:8px">
      <button class="btn" id="modalCancel">ยกเลิก</button>
      <button class="btn primary" id="modalOk">ตกลง</button>
    </div>
  </dialog>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCLtVPtIqs6GlHzX108cvFEvLh6Z0i-nBw",
      authDomain: "clip-61b0b.firebaseapp.com",
      projectId: "clip-61b0b",
      storageBucket: "clip-61b0b.firebasestorage.app",
      messagingSenderId: "63156543329",
      appId: "1:63156543329:web:9243a29ec5e3cf4225af20",
      measurementId: "G-JCJVWHD6YK"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const ADMIN_EMAIL = 'sptmorral@spt.ac.th';

    // UI helpers
    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
    function toast(msg){
      const t = document.createElement('div');
      t.textContent = msg; t.style.cssText = 'position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);z-index:50';
      document.body.appendChild(t); setTimeout(()=>t.remove(), 2500);
    }
    function setRoute(route){
      $$('.route').forEach(el=>el.classList.add('hidden'));
      const target = $(`#route-${route}`); if(target) target.classList.remove('hidden');
      // update nav active
      $$('[data-route]').forEach(b=>b.classList.toggle('active', b.dataset.route===route));
      localStorage.setItem('route', route);
    }
    function openModal(title, bodyHTML, onOk){
      const modal = $('#modal');
      $('#modalTitle').textContent = title;
      $('#modalBody').innerHTML = bodyHTML;
      const okBtn = $('#modalOk');
      const cancelBtn = $('#modalCancel');
      const cleanup = () => {
        okBtn.onclick = null; cancelBtn.onclick = null;
        modal.close();
      };
      okBtn.onclick = async () => { try{ await onOk?.(); cleanup(); } catch(e){ console.error(e); toast(e.message || 'เกิดข้อผิดพลาด'); } };
      cancelBtn.onclick = cleanup;
      modal.showModal();
    }

    // Auth state and menu
    function renderMenu(user, isAdmin){
      const nav = $('#nav');
      nav.innerHTML = '';
      const left = document.createElement('div');
      left.style.display='flex'; left.style.gap='8px'; left.style.flexWrap='wrap';
      const right = document.createElement('div');
      right.style.display='flex'; right.style.gap='8px';
      const routes = [
        {key:'dashboard', label:'หน้าหลัก'},
        {key:'events', label:'กิจกรรม'},
        {key:'links', label:'ลิงก์'},
        {key:'docs', label:'เอกสาร'},
        {key:'inventory', label:'ยืม-คืนอุปกรณ์'},
        {key:'calendar', label:'ปฏิทิน'},
      ];
      routes.forEach(r=>{
        const b=document.createElement('button'); b.className='btn'; b.dataset.route=r.key; b.textContent=r.label; b.onclick=()=>setRoute(r.key); left.appendChild(b);
      });
      if(isAdmin){
        const b=document.createElement('button'); b.className='btn'; b.dataset.route='admin'; b.textContent='จัดการระบบ'; b.onclick=()=>setRoute('admin'); left.appendChild(b);
      }
      const change = Object.assign(document.createElement('button'), {id:'changePasswordBtn', className:'btn', textContent:'แก้ไขรหัสผ่าน'});
      change.onclick = () => openModal('แก้ไขรหัสผ่าน', `
        <form id="pwdForm" class="form">
          <input id="newPwd" type="password" placeholder="รหัสผ่านใหม่ (≥6)" minlength="6" required />
        </form>
      `, async ()=>{
        const newPwd = $('#newPwd').value.trim();
        if(newPwd.length < 6) throw new Error('รหัสผ่านอย่างน้อย 6 ตัวอักษร');
        await auth.currentUser.updatePassword(newPwd);
        toast('บันทึกรหัสผ่านใหม่แล้ว');
      });
      const logout = Object.assign(document.createElement('button'), {id:'logoutBtn', className:'btn', textContent:'ออกจากระบบ'});
      logout.onclick = ()=>auth.signOut();
      right.appendChild(change); right.appendChild(logout);

      const wrap = document.createElement('div');
      wrap.style.display='flex'; wrap.style.gap='12px'; wrap.style.alignItems='center'; wrap.style.flexWrap='wrap';
      wrap.appendChild(left); wrap.appendChild(right);
      nav.appendChild(wrap);
    }

    // Firestore helpers
    const col = (name) => db.collection(name);
    const nowTs = () => firebase.firestore.FieldValue.serverTimestamp();

    // Access rules (client-enforced; set server rules in Firebase console!)
    function isAdminUser(user){ return user?.email?.toLowerCase() === ADMIN_EMAIL; }

    // Bootstrap auth UI
    const lastRoute = localStorage.getItem('route') || 'dashboard';

    auth.onAuthStateChanged(async (user)=>{
      if(!user){
        $('#auth').classList.remove('hidden');
        $('#app').classList.add('hidden');
        $('#nav').innerHTML='';
        return;
      }
      const approvedSnap = await col('users').doc(user.uid).get();
      const approved = approvedSnap.exists ? approvedSnap.data().approved === true : isAdminUser(user);
      const admin = isAdminUser(user);
      renderMenu(user, admin);
      $('#auth').classList.add('hidden');
      $('#app').classList.remove('hidden');

      if(!approved && !admin){
        // Gate UI until approved
        openModal('รอการอนุมัติ', `<p>บัญชีของคุณกำลังรอผู้ดูแลอนุมัติ โปรดลองใหม่ภายหลัง</p>`, ()=>{});
      }
      setRoute(lastRoute);
      await refreshAll(user, {admin, approved});
    });

    // Auth forms
    $('#goRegister')?.addEventListener('click', (e)=>{ e.preventDefault(); $('.auth-card').scrollTo({top:1000, behavior:'smooth'}) });
    $('#goLogin')?.addEventListener('click', (e)=>{ e.preventDefault(); $('.auth-card').scrollTo({top:0, behavior:'smooth'}) });

    $('#loginForm')?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = $('#loginEmail').value.trim();
      const password = $('#loginPassword').value;
      try{ await auth.signInWithEmailAndPassword(email, password); toast('ยินดีต้อนรับ'); }catch(err){ toast(err.message || 'เข้าสู่ระบบไม่สำเร็จ'); }
    });

    $('#registerForm')?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const title = $('#title').value;
      const first = $('#firstName').value.trim();
      const last = $('#lastName').value.trim();
      const email = $('#regEmail').value.trim();
      const pw1 = $('#regPassword').value; const pw2 = $('#regPassword2').value;
      if(pw1 !== pw2){ toast('รหัสผ่านไม่ตรงกัน'); return; }
      try{
        const cred = await auth.createUserWithEmailAndPassword(email, pw1);
        const profile = { title, first, last, email, createdAt: nowTs(), approved: isAdminUser({email}) };
        await col('users').doc(cred.user.uid).set(profile);
        toast('สมัครสมาชิกสำเร็จ โปรดรอผู้ดูแลอนุมัติ');
      }catch(err){ toast(err.message || 'สมัครสมาชิกไม่สำเร็จ'); }
    });

    // Data models
    // Collections: users, events, links, documents, equipment, borrowRequests, approvals

    // Create add/edit dialogs and list renderers
    function renderEvents(user, ctx){
      const list = $('#eventsList'); list.innerHTML='';
      col('events').orderBy('startDate').limit(200).onSnapshot((snap)=>{
        list.innerHTML='';
        snap.forEach(doc=>{
          const d = doc.data(); if(d.deleted) return;
          if(d.approved !== true && !ctx.admin && d.createdBy !== user.uid) return;
          const el = document.createElement('div'); el.className='item';
          el.innerHTML = `
            <strong>${d.name || 'ไม่ระบุ'}</strong>
            <div class="meta">${fmtRange(d)}</div>
            <div>${(d.details||'').slice(0,240)}</div>
            ${ctx.admin? '<div><button class="btn danger" data-del>ลบ</button></div>':''}
          `;
          if(ctx.admin){
            el.querySelector('[data-del]')?.addEventListener('click', async ()=>{
              await col('events').doc(doc.id).update({deleted:true}); toast('ลบแล้ว');
            });
          }
          list.appendChild(el);
        })
      })
      $('#addEventBtn').onclick = ()=> openEventDialog();
    }

    function renderLinks(user, ctx){
      const list = $('#linksList'); list.innerHTML='';
      col('links').orderBy('createdAt','desc').limit(200).onSnapshot((snap)=>{
        list.innerHTML='';
        snap.forEach(doc=>{
          const d = doc.data(); if(d.deleted) return;
          if(d.approved !== true && !ctx.admin && d.createdBy !== user.uid) return;
          const el = document.createElement('div'); el.className='item';
          el.innerHTML = `
            <strong>${d.title || 'ไม่ระบุ'}</strong>
            <div class="meta"><a href="${d.url}" target="_blank">เปิดลิงก์</a></div>
            <div>${(d.details||'').slice(0,240)}</div>
            ${ctx.admin? '<div><button class="btn danger" data-del>ลบ</button></div>':''}
          `;
          if(ctx.admin){
            el.querySelector('[data-del]')?.addEventListener('click', async ()=>{
              await col('links').doc(doc.id).update({deleted:true}); toast('ลบแล้ว');
            });
          }
          list.appendChild(el);
        })
      })
      $('#addLinkBtn').onclick = ()=> openLinkDialog();
    }

    function renderDocs(user, ctx){
      const list = $('#docsList'); list.innerHTML='';
      col('documents').orderBy('createdAt','desc').limit(200).onSnapshot((snap)=>{
        list.innerHTML='';
        snap.forEach(doc=>{
          const d = doc.data(); if(d.deleted) return;
          if(d.approved !== true && !ctx.admin && d.createdBy !== user.uid) return;
          const el = document.createElement('div'); el.className='item';
          el.innerHTML = `
            <strong>${d.title || 'ไม่ระบุ'}</strong>
            <div class="meta"><a href="${d.url}" target="_blank">เปิดเอกสาร</a></div>
            <div>${(d.details||'').slice(0,240)}</div>
            ${ctx.admin? '<div><button class="btn danger" data-del>ลบ</button></div>':''}
          `;
          if(ctx.admin){
            el.querySelector('[data-del]')?.addEventListener('click', async ()=>{
              await col('documents').doc(doc.id).update({deleted:true}); toast('ลบแล้ว');
            });
          }
          list.appendChild(el);
        })
      })
      $('#addDocBtn').onclick = ()=> openDocDialog();
    }

    function renderInventory(user, ctx){
      const avail = $('#inventoryAvailable');
      const borrowed = $('#inventoryBorrowed');
      const uid = user.uid;
      function refresh(){
        avail.innerHTML=''; borrowed.innerHTML='';
        col('equipment').orderBy('name').onSnapshot((snap)=>{
          avail.innerHTML='';
          snap.forEach(doc=>{
            const d = doc.data(); if(d.deleted) return;
            const availableQty = (d.quantity||0) - (d.borrowed||0);
            const el = document.createElement('div'); el.className='item';
            el.innerHTML = `
              <strong>${d.name}</strong>
              <div class="meta">คงเหลือ ${availableQty}/${d.quantity||0}</div>
              <div><button class="btn" data-borrow>ยืมอุปกรณ์</button></div>
            `;
            el.querySelector('[data-borrow]')?.addEventListener('click', async ()=>{
              if(availableQty<=0){ toast('อุปกรณ์ไม่พอ'); return; }
              await col('borrows').add({equipmentId:doc.id, userId:uid, qty:1, status:'borrowed', createdAt: nowTs()});
              await col('equipment').doc(doc.id).update({borrowed:(d.borrowed||0)+1});
              toast('ทำรายการยืมแล้ว');
            })
            avail.appendChild(el);
          })
        })
        col('borrows').where('userId','==',uid).where('status','==','borrowed').onSnapshot(async (snap)=>{
          borrowed.innerHTML='';
          const eqMap = {}; const eqSnap = await col('equipment').get(); eqSnap.forEach(e=>eqMap[e.id]=e.data());
          snap.forEach(doc=>{
            const d = doc.data(); const e = eqMap[d.equipmentId]||{};
            const el = document.createElement('div'); el.className='item';
            el.innerHTML = `
              <strong>${e.name||'อุปกรณ์'}</strong>
              <div class="meta">จำนวน ${d.qty||1}</div>
              <div><button class="btn" data-return>คืนอุปกรณ์</button></div>
            `;
            el.querySelector('[data-return]')?.addEventListener('click', async ()=>{
              await col('borrows').doc(doc.id).update({status:'returned', returnedAt: nowTs()});
              const curr = (e.borrowed||0); await col('equipment').doc(d.equipmentId).update({borrowed: Math.max(0, curr-1)});
              toast('คืนอุปกรณ์แล้ว');
            })
            borrowed.appendChild(el);
          })
        })
      }
      refresh();
    }

    function renderCalendar(user, ctx){
      const view = $('#calendarView'); view.innerHTML='';
      col('calendar').orderBy('startDate').limit(400).onSnapshot((snap)=>{
        view.innerHTML='';
        // Simple month grid placeholder
        for(let i=1;i<=28;i++){
          const cell = document.createElement('div'); cell.className='day'; cell.innerHTML=`<div style="font-size:12px; color:var(--muted)">${i}</div>`; view.appendChild(cell);
        }
        snap.forEach(doc=>{
          const d = doc.data(); if(d.deleted) return;
          if(d.approved !== true && !ctx.admin && d.createdBy !== user.uid) return;
          // Attach to first day for demo
          const cell = view.children[0];
          const pill = document.createElement('div');
          pill.style.cssText='margin-top:6px;background:var(--card);border:1px solid #e5e7eb;padding:6px 8px;border-radius:10px;font-size:12px';
          pill.textContent = `${d.type==='meeting'?'[ประชุม]':'[กิจกรรม]'} ${d.name}`;
          cell.appendChild(pill);
        })
      })
      $('#addCalendarBtn').onclick = ()=> openCalendarDialog();
    }

    function renderDashboard(user, ctx){
      // Calendar compact
      const cal = $('#dashboardCalendar'); cal.innerHTML='';
      for(let i=1;i<=21;i++){
        const cell = document.createElement('div'); cell.className='day'; cell.innerHTML=`<div style="font-size:12px; color:var(--muted)">${i}</div>`; cal.appendChild(cell);
      }
      col('calendar').orderBy('startDate').limit(20).onSnapshot((snap)=>{
        // attach to first cell for demo
        const cell = cal.children[0];
        cell.innerHTML = '<div style="font-size:12px; color:var(--muted)">1</div>';
        snap.forEach(doc=>{
          const d = doc.data(); if(d.deleted) return; if(d.approved!==true && !ctx.admin && d.createdBy!==user.uid) return;
          const pill = document.createElement('div'); pill.style.cssText='margin-top:6px;background:var(--card);border:1px solid #e5e7eb;padding:6px 8px;border-radius:10px;font-size:12px'; pill.textContent = d.name; cell.appendChild(pill);
        })
      })
      // Inventory status
      const inv = $('#dashboardInventory'); inv.innerHTML='';
      col('equipment').orderBy('name').limit(5).onSnapshot((snap)=>{
        inv.innerHTML=''; snap.forEach(doc=>{
          const d = doc.data(); if(d.deleted) return;
          const available = (d.quantity||0)-(d.borrowed||0);
          const el = document.createElement('div'); el.className='item'; el.innerHTML = `<strong>${d.name}</strong><div class="meta">คงเหลือ ${available}/${d.quantity||0}</div>`;
          inv.appendChild(el);
        })
      })
      // Latest links
      const links = $('#dashboardLinks'); links.innerHTML='';
      col('links').where('approved','==',true).orderBy('createdAt','desc').limit(5).onSnapshot((snap)=>{
        links.innerHTML=''; snap.forEach(doc=>{
          const d = doc.data(); const el = document.createElement('div'); el.className='item'; el.innerHTML = `<a href="${d.url}" target="_blank"><strong>${d.title}</strong></a><div class="meta">${(d.details||'').slice(0,100)}</div>`; links.appendChild(el);
        })
      })
      // Latest docs
      const docs = $('#dashboardDocs'); docs.innerHTML='';
      col('documents').where('approved','==',true).orderBy('createdAt','desc').limit(5).onSnapshot((snap)=>{
        docs.innerHTML=''; snap.forEach(doc=>{
          const d = doc.data(); const el = document.createElement('div'); el.className='item'; el.innerHTML = `<a href="${d.url}" target="_blank"><strong>${d.title}</strong></a><div class="meta">${(d.details||'').slice(0,100)}</div>`; docs.appendChild(el);
        })
      })
      // Upcoming
      const up = $('#dashboardUpcoming'); up.innerHTML='';
      col('events').where('approved','==',true).orderBy('startDate').limit(5).onSnapshot((snap)=>{
        up.innerHTML=''; snap.forEach(doc=>{
          const d = doc.data(); const el = document.createElement('div'); el.className='item'; el.innerHTML = `<strong>${d.name}</strong><div class="meta">${fmtRange(d)}</div>`; up.appendChild(el);
        })
      })
    }

    // Admin console
    function renderAdmin(user){
      const approvals = $('#approvals'); approvals.innerHTML='';
      function renderApprovalGroup(groupTitle, query){
        const card = document.createElement('div'); card.className='item';
        const header = document.createElement('div'); header.innerHTML = `<strong>${groupTitle}</strong>`; card.appendChild(header);
        const list = document.createElement('div'); list.className='list'; card.appendChild(list);
        approvals.appendChild(card);
        query.onSnapshot((snap)=>{
          list.innerHTML='';
          snap.forEach(doc=>{
            const d = doc.data();
            const row = document.createElement('div'); row.className='item';
            const approveBtn = `<button class="btn primary" data-approve>อนุมัติ</button>`;
            const rejectBtn = `<button class="btn danger" data-reject>ปฏิเสธ</button>`;
            row.innerHTML = `<div><strong>${d.name||d.title||d.email||'รายการ'}</strong></div><div class="meta">${d.details||d.url||''}</div><div>${approveBtn} ${rejectBtn}</div>`;
            row.querySelector('[data-approve]').onclick = async ()=>{
              await doc.ref.update({approved:true}); toast('อนุมัติแล้ว');
            };
            row.querySelector('[data-reject]').onclick = async ()=>{
              await doc.ref.update({approved:false}); toast('ปฏิเสธแล้ว');
            };
            list.appendChild(row);
          })
        })
      }
      renderApprovalGroup('ผู้ใช้ใหม่รออนุมัติ', col('users').where('approved','==',false));
      renderApprovalGroup('กิจกรรมรออนุมัติ', col('events').where('approved','==',false));
      renderApprovalGroup('ลิงก์รออนุมัติ', col('links').where('approved','==',false));
      renderApprovalGroup('เอกสารรออนุมัติ', col('documents').where('approved','==',false));
      renderApprovalGroup('ปฏิทินรออนุมัติ', col('calendar').where('approved','==',false));

      // Equipment manage
      const eqList = $('#equipmentList'); eqList.innerHTML='';
      $('#addEquipmentBtn').onclick = ()=> openModal('เพิ่มอุปกรณ์', `
        <form id="eqForm" class="form">
          <input id="eqName" placeholder="ชื่ออุปกรณ์" required />
          <input id="eqQty" type="number" min="0" placeholder="จำนวน" required />
        </form>
      `, async ()=>{
        const name=$('#eqName').value.trim(); const qty=Number($('#eqQty').value||0);
        if(!name) throw new Error('กรอกชื่อ');
        await col('equipment').add({name, quantity:qty, borrowed:0, createdAt: nowTs()});
      });
      col('equipment').orderBy('name').onSnapshot((snap)=>{
        eqList.innerHTML='';
        snap.forEach(doc=>{
          const d = doc.data(); if(d.deleted) return;
          const el = document.createElement('div'); el.className='item';
          el.innerHTML = `
            <strong>${d.name}</strong>
            <div class="meta">จำนวน ${d.quantity||0}, ถูกยืม ${d.borrowed||0}</div>
            <div><button class="btn danger" data-del>ลบ</button></div>
          `;
          el.querySelector('[data-del]').onclick = async ()=>{
            await col('equipment').doc(doc.id).update({deleted:true}); toast('ลบแล้ว');
          };
          eqList.appendChild(el);
        })
      })

      // Users manage
      const users = $('#usersList'); users.innerHTML='';
      col('users').orderBy('createdAt','desc').limit(500).onSnapshot((snap)=>{
        users.innerHTML='';
        snap.forEach(doc=>{
          const d = doc.data(); if(d.deleted) return;
          const el = document.createElement('div'); el.className='item';
          el.innerHTML = `
            <div><strong>${d.title||''} ${d.first||''} ${d.last||''}</strong></div>
            <div class="meta">${d.email}</div>
            <div>
              <button class="btn" data-reset>ส่งลิงก์รีเซ็ตรหัสผ่าน</button>
              <button class="btn danger" data-del>ลบบัญชี</button>
            </div>
          `;
          el.querySelector('[data-reset]').onclick = async ()=>{
            await auth.sendPasswordResetEmail(d.email); toast('ส่งลิงก์รีเซ็ตแล้ว');
          };
          el.querySelector('[data-del]').onclick = async ()=>{
            await col('users').doc(doc.id).update({deleted:true}); toast('ทำเครื่องหมายลบแล้ว');
          };
          users.appendChild(el);
        })
      })
    }

    // Dialog creators
    function openEventDialog(){
      openModal('เพิ่มกิจกรรม', `
        <form id="eventForm" class="form">
          <input id="evName" placeholder="ชื่อกิจกรรม" required />
          <div class="row">
            <input id="evStartDate" type="date" required />
            <input id="evStartTime" type="time" required />
          </div>
          <div class="row">
            <input id="evEndDate" type="date" required />
            <input id="evEndTime" type="time" required />
          </div>
          <textarea id="evDetails" rows="3" placeholder="รายละเอียด"></textarea>
          <label><input id="evAllDay" type="checkbox"/> ตลอดทั้งวัน</label>
        </form>
      `, async ()=>{
        const user = auth.currentUser; if(!user) throw new Error('กรุณาเข้าสู่ระบบ');
        const data = {
          name: $('#evName').value.trim(),
          startDate: $('#evStartDate').value,
          startTime: $('#evStartTime').value,
          endDate: $('#evEndDate').value,
          endTime: $('#evEndTime').value,
          details: $('#evDetails').value.trim(),
          allDay: $('#evAllDay').checked,
          approved: false,
          createdBy: user.uid,
          createdAt: nowTs()
        };
        await col('events').add(data); toast('ส่งคำขอเพิ่มกิจกรรมแล้ว');
      });
    }

    function openLinkDialog(){
      openModal('เพิ่มลิงก์', `
        <form id="linkForm" class="form">
          <input id="lnTitle" placeholder="ชื่อลิงก์" required />
          <input id="lnUrl" type="url" placeholder="ลิงก์ (https://...)" required />
          <textarea id="lnDetails" rows="3" placeholder="รายละเอียด"></textarea>
        </form>
      `, async ()=>{
        const user = auth.currentUser; if(!user) throw new Error('กรุณาเข้าสู่ระบบ');
        const data = {
          title: $('#lnTitle').value.trim(),
          url: $('#lnUrl').value.trim(),
          details: $('#lnDetails').value.trim(),
          approved: false,
          createdBy: user.uid,
          createdAt: nowTs()
        };
        await col('links').add(data); toast('ส่งคำขอเพิ่มลิงก์แล้ว');
      });
    }

    function openDocDialog(){
      openModal('เพิ่มเอกสาร', `
        <form id="docForm" class="form">
          <input id="dcTitle" placeholder="ชื่อเอกสาร" required />
          <input id="dcUrl" type="url" placeholder="ลิงก์เอกสาร (https://...)" required />
          <textarea id="dcDetails" rows="3" placeholder="รายละเอียด"></textarea>
        </form>
      `, async ()=>{
        const user = auth.currentUser; if(!user) throw new Error('กรุณาเข้าสู่ระบบ');
        const data = {
          title: $('#dcTitle').value.trim(),
          url: $('#dcUrl').value.trim(),
          details: $('#dcDetails').value.trim(),
          approved: false,
          createdBy: user.uid,
          createdAt: nowTs()
        };
        await col('documents').add(data); toast('ส่งคำขอเพิ่มเอกสารแล้ว');
      });
    }

    function openCalendarDialog(){
      openModal('เพิ่มกิจกรรมปฏิทิน', `
        <form id="calForm" class="form">
          <input id="clName" placeholder="ชื่อกิจกรรม" required />
          <select id="clType" required>
            <option value="event">กิจกรรม</option>
            <option value="meeting">ประชุม</option>
          </select>
          <div class="row">
            <input id="clStartDate" type="date" required />
            <input id="clStartTime" type="time" required />
          </div>
          <div class="row">
            <input id="clEndDate" type="date" required />
            <input id="clEndTime" type="time" required />
          </div>
          <textarea id="clDetails" rows="3" placeholder="รายละเอียด"></textarea>
          <label><input id="clAllDay" type="checkbox"/> ตลอดทั้งวัน</label>
        </form>
      `, async ()=>{
        const user = auth.currentUser; if(!user) throw new Error('กรุณาเข้าสู่ระบบ');
        const data = {
          name: $('#clName').value.trim(),
          type: $('#clType').value,
          startDate: $('#clStartDate').value,
          startTime: $('#clStartTime').value,
          endDate: $('#clEndDate').value,
          endTime: $('#clEndTime').value,
          details: $('#clDetails').value.trim(),
          allDay: $('#clAllDay').checked,
          approved: false,
          createdBy: user.uid,
          createdAt: nowTs()
        };
        await col('calendar').add(data); toast('ส่งคำขอเพิ่มในปฏิทินแล้ว');
      });
    }

    // Utilities
    function fmtRange(d){
      const s = [d.startDate, d.startTime].filter(Boolean).join(' ');
      const e = [d.endDate, d.endTime].filter(Boolean).join(' ');
      return `${s} - ${e}`;
    }

    async function refreshAll(user, ctx){
      renderDashboard(user, ctx);
      renderEvents(user, ctx);
      renderLinks(user, ctx);
      renderDocs(user, ctx);
      renderInventory(user, ctx);
      renderCalendar(user, ctx);
      if(ctx.admin) renderAdmin(user);
    }
  </script>
</body>
</html>
